parameters:
- name: TargetBranch
  displayName: Branch this module will generated to
  type: string
  default: main
- name: ServiceName
  displayName: Service to OOB release
  type: string
  default: Databricks
resources:
  repositories:
  - repository: self
    type: git
jobs:
- job: OOBRelease
  timeoutInMinutes: 180
  pool: pool-windows-2019
  steps:
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      command: custom
      custom: msbuild
      arguments: 'build.proj /t:Clean;Build /p:Configuration=Release'
  - task: UseDotNet@2
    inputs:
      version: '3.1.x'
  - pwsh: |
        .\tools\RunVersionController.ps1 -ModuleName "Az.${{ parameters.ServiceName }}‚Äù
    displayName: 'Bump up version'
  - task: AzurePowerShell@5
    inputs:
        azureSubscription: 'azureps-infra-sp'
        ScriptType: 'InlineScript'
        azurePowerShellVersion: 'LatestVersion'
        inline: |
            Set-AzContext -Tenant 72f988bf-86f1-41af-91ab-2d7cd011db47 -SubscriptionId 6b085460-5f21-477e-ba44-1035046e9101
            $Token = Get-AzKeyVaultSecret -VaultName azurepsdev -Name azpsbot-github-pat -AsPlainText
            git config user.email "65331932+azure-powershell-bot@users.noreply.github.com"
            git config user.name "azure-powershell-bot"
            $branchSource = "$(Build.SourceBranch)"
            $Current = $branchSource -replace "refs/heads/", ""
            git add -A
            git commit -m "Bump up version for ${{ parameters.ServiceName }}"
            git remote set-url origin https://azure-powershell-bot:$Token@github.com/Azure/azure-powershell.git;
            git push origin $Current --force;
            $Title = "Migrate ${{ parameters.ServiceName }} from oob to main"
            $HeadBranch = $Current
            $BaseBranch = "${{ parameters.TargetBranch }}"
            $Description = "Migrate ${{ parameters.ServiceName }} from oob to ${{parameters.TargetBranch}}"
            ./tools/Github/CreatePR.ps1 -Title $Title -HeadBranch $HeadBranch -BaseBranch $BaseBranch -BotAccessToken $Token -Description $Description
    displayName: Create PR to main branch
  - task: PowerShell@2
    displayName: get changelog info
    inputs:
      targetType: 'inline'
      script: |
        $readme = Get-ChildItem -Path "./src/${{ parameters.ServiceName }}" -name ChangeLog.md -Recurse
        $mdContent = Get-Content -Path "src/${{ parameters.ServiceName }}/$readme" -Raw
        $pattern = '(?s)## Version (\d+\.\d+\.\d)+[\s\S]*?\n(.*?)(?=\n## Version \d+\.\d+\.\d+|$)'
        $matches = [regex]::Match($mdcontent, $pattern)
        if ($matches.Success) {
            $versionNumber = $matches.Groups[1].Value
            $versionChanges = $matches.Groups[2].Value.Trim()
        }
        $jsonData = @{
          ModuleName = "${{ parameters.ServiceName }}"
          VersionNumber = "$versionNumber"
          VersionChanges = "$versionChanges"
        }
        $jsonString = $jsonData | ConvertTo-Json
        $jsonString | Out-File -FilePath "VersionInfo.json"
        $folderPath = "OOB"
        $fileName = "VersionInfo.json"
        New-Item -ItemType Directory -Force -Path $folderPath | Out-Null
        $filePath = Join-Path -Path $folderPath -ChildPath $fileName
        $jsonString | Out-File -FilePath $filePath
  - task: PowerShell@2
    displayName: publish oob tools
    inputs:
      targetType: 'inline'
      script: |
        Copy-Item .\tools\ModulePublisher.psd1 -Destination OOB
        Copy-Item .\tools\ModulePublisher.psm1 -Destination OOB
        Copy-Item .\tools\NuGet.exe -Destination OOB
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: OOB
      ArtifactName: OOB
- template: code-sign.yml
  parameters:
    DependsOn: OOBRelease
