parameters:
- name: TargetBranch
  displayName: Branch this module will generated to
  type: string
  default: main
- name: ServiceName
  displayName: Service to OOB release
  type: string
  default: Databricks
stages:
- stage: OOBRelease
  displayName: OOBRelease
  jobs:
  - job: OOBRelease
    timeoutInMinutes: 180
    pool: pool-windows-2019
    steps:
    - task: PowerShell@2
      displayName: get changelog info
      inputs:
        targetType: 'inline'
        script: |
          $readme = Get-ChildItem -Path "./src/${{ parameters.ServiceName }}" -name ChangeLog.md -Recurse
          $mdContent = Get-Content -Path "src/${{ parameters.ServiceName }}/$readme" -Raw
          $pattern = '(?s)## Version (\d+\.\d+\.\d)+[\s\S]*?\n(.*?)(?=\n## Version \d+\.\d+\.\d+|$)'
          $matches = [regex]::Match($mdcontent, $pattern)
          if ($matches.Success) {
              $versionNumber = $matches.Groups[1].Value
              $versionChanges = $matches.Groups[2].Value.Trim()
          }
          $jsonData = @{
            ModuleName = "${{ parameters.ServiceName }}"
            VersionNumber = "$versionNumber"
            VersionChanges = "$versionChanges"
          }
          $jsonString = $jsonData | ConvertTo-Json
          $jsonString | Out-File -FilePath "VersionInfo.json"
          $folderPath = "OOB"
          $fileName = "VersionInfo.json"
          New-Item -ItemType Directory -Force -Path $folderPath | Out-Null
          $filePath = Join-Path -Path $folderPath -ChildPath $fileName
          $jsonString | Out-File -FilePath $filePath
    - task: PowerShell@2
      displayName: publish oob tools
      inputs:
        targetType: 'inline'
        script: |
          Copy-Item .\tools\ModulePublisher.psd1 -Destination OOB
          Copy-Item .\tools\ModulePublisher.psm1 -Destination OOB
          Copy-Item .\tools\NuGet.exe -Destination OOB
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: OOB
        ArtifactName: OOB
- stage: Codesign
  dependsOn: OOBRelease
  jobs:
  - job: PulishForTest
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'OOB'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: AzurePowerShell@5
      displayName: 'Push packages to storage account'
      inputs:
        azureSubscription: 'azureps-infra-sp'
        ScriptType: InlineScript
        azurePowerShellVersion: LatestVersion
        pwsh: true
        Inline: |
          $jsonFilePath = "$(System.ArtifactsDirectory)/OOB/VersionInfo.json"
          $jsonContent = Get-Content -Path $jsonFilePath -Raw
          $jsonObject = $jsonContent | ConvertFrom-Json
          $versionNumber = $jsonObject.VersionNumber
          $versionChanges = $jsonObject.VersionChanges
          $moduleName = $jsonObject.ModuleName
          $context = New-AzStorageContext -StorageAccountName "$(TestStorageAccountName)"
