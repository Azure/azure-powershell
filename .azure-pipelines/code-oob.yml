parameters:
- name: TargetBranch
  displayName: Branch this module will generated to
  type: string
  default: main
- name: ServiceName
  displayName: Service to OOB release
  type: string
  default: Databricks
stages:
- stage: Codesign
  jobs:
  - job: PulishForTest
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'specific'
        project: '9b6b54d1-85ce-4ff5-8faa-608b4a183fc6'
        pipeline: '316'
        buildVersionToDownload: 'specific'
        buildId: '62487'
        downloadType: 'single'
        artifactName: 'OOB'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'specific'
        project: '9b6b54d1-85ce-4ff5-8faa-608b4a183fc6'
        pipeline: '316'
        buildVersionToDownload: 'specific'
        buildId: '62487'
        downloadType: 'single'
        artifactName: 'artifacts'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: AzurePowerShell@5
      displayName: 'Push packages to storage account'
      inputs:
        azureSubscription: 'azureps-infra-sp'
        ScriptType: InlineScript
        azurePowerShellVersion: LatestVersion
        pwsh: true
        Inline: |
          $jsonFilePath = "$(System.ArtifactsDirectory)/OOB/VersionInfo.json"
          $jsonContent = Get-Content -Path $jsonFilePath -Raw
          $jsonObject = $jsonContent | ConvertFrom-Json
          $versionNumber = $jsonObject.VersionNumber
          $versionChanges = $jsonObject.VersionChanges
          $moduleName = $jsonObject.ModuleName
          $context = New-AzStorageContext -StorageAccountName "$(TestStorageAccountName)"
          $package = Get-Item "$(System.ArtifactsDirectory)/artifacts/Az.$moduleName.$versionNumber.nupkg"
          $package | Set-AzStorageBlobContent -Container "public" -Context $context -Force



