parameters:
- name: TargetBranch
  displayName: Branch this module will generated to
  type: string
  default: main
- name: ServiceName
  displayName: Service to OOB release
  type: string
  default: Databricks
resources:
  repositories:
  - repository: self
    type: git
jobs:
- job: OOBRelease
  timeoutInMinutes: 180
  pool: pool-windows-2019
  steps:
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        $readme = Get-ChildItem -Path "./src/${{ parameters.ServiceName }}" -name ChangeLog.md -Recurse
        $mdContent = Get-Content -Path "src/${{ parameters.ServiceName }}/$readme" -Raw
        $pattern = '(?s)## Version (\d+\.\d+\.\d)+[\s\S]*?\n(.*?)(?=\n## Version \d+\.\d+\.\d+|$)'
        $matches = [regex]::Match($mdcontent, $pattern)
        if ($matches.Success) {
            $versionNumber = $matches.Groups[1].Value
            $versionChanges = $matches.Groups[2].Value.Trim()
        }
        $jsonData = @{
          ModuleName = ${{ parameters.ServiceName }}
          VersionNumber = $versionNumber
          VersionChanges = $versionChanges
        }
        $jsonString = $jsonData | ConvertTo-Json
        $jsonString | Out-File -FilePath "VersionInfo.json"
        $folderPath = "VersionInfo"
        $fileName = "VersionInfo.json"
        New-Item -ItemType Directory -Force -Path $folderPath | Out-Null
        $filePath = Join-Path -Path $folderPath -ChildPath $fileName
        $jsonString | Out-File -FilePath $filePath
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'VersionInfo'
      publishLocation: 'Container'
  
- template: code-sign.yml
  parameters:
    DependsOn: OOBRelease

  