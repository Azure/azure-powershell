parameters:
- name: TargetBranch
  displayName: Branch this module will generated to
  type: string
  default: main
- name: ServiceName
  displayName: Service to OOB release
  type: string
  default: Databricks
- name: PreRelease
  displayName: Is preview release
  type: boolean
  default: false
stages:
- stage: OOBRelease
  displayName: OOBRelease
  jobs:
  - job: OOBRelease
    timeoutInMinutes: 180
    pool: pool-windows-2019
    steps:
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: custom
        custom: msbuild
        arguments: 'build.proj /t:Clean;Build /p:Configuration=Release'
    - task: UseDotNet@2
      inputs:
        version: '3.1.x'
    - pwsh: |
          .\tools\RunVersionController.ps1 -ModuleName "Az.${{ parameters.ServiceName }}‚Äù
      displayName: 'Bump up version'
    - task: AzurePowerShell@5
      inputs:
          azureSubscription: 'azureps-infra-sp'
          ScriptType: 'InlineScript'
          azurePowerShellVersion: 'LatestVersion'
          inline: |
              Set-AzContext -Tenant 72f988bf-86f1-41af-91ab-2d7cd011db47 -SubscriptionId 6b085460-5f21-477e-ba44-1035046e9101
              $Token = Get-AzKeyVaultSecret -VaultName azurepsdev -Name azpsbot-github-pat -AsPlainText
              git config user.email "65331932+azure-powershell-bot@users.noreply.github.com"
              git config user.name "azure-powershell-bot"
              git checkout -b codeoob/${{ parameters.ServiceName }}
              git add -A
              git commit -m "Bump up version for ${{ parameters.ServiceName }}"
              git remote set-url origin https://azure-powershell-bot:$Token@github.com/Azure/azure-powershell.git;
              git push origin codeoob/${{ parameters.ServiceName }} --force;
              $Title = "Migrate ${{ parameters.ServiceName }} from oob to main"
              $HeadBranch = "codeoob/${{ parameters.ServiceName }}"
              $BaseBranch = "${{ parameters.TargetBranch }}"
              $Description = "Migrate ${{ parameters.ServiceName }} from oob to ${{parameters.TargetBranch}}"
              ./tools/Github/CreatePR.ps1 -Title $Title -HeadBranch $HeadBranch -BaseBranch $BaseBranch -BotAccessToken $Token -Description $Description
      displayName: Create PR to main branch
    - task: PowerShell@2
      displayName: get changelog info
      inputs:
        targetType: 'inline'
        script: |
          $readme = Get-ChildItem -Path "./src/${{ parameters.ServiceName }}" -name ChangeLog.md -Recurse
          $mdContent = Get-Content -Path "src/${{ parameters.ServiceName }}/$readme" -Raw
          $pattern = '(?s)## Version (\d+\.\d+\.\d)+[\s\S]*?\n(.*?)(?=\n## Version \d+\.\d+\.\d+|$)'
          $matches = [regex]::Match($mdcontent, $pattern)
          if ($matches.Success) {
              $versionNumber = $matches.Groups[1].Value
              $versionChanges = $matches.Groups[2].Value.Trim()
          }
          $jsonData = @{
            ModuleName = "${{ parameters.ServiceName }}"
            VersionNumber = "$versionNumber"
            VersionChanges = "$versionChanges"
          }
          $jsonString = $jsonData | ConvertTo-Json
          $jsonString | Out-File -FilePath "VersionInfo.json"
          $folderPath = "OOB"
          $fileName = "VersionInfo.json"
          New-Item -ItemType Directory -Force -Path $folderPath | Out-Null
          $filePath = Join-Path -Path $folderPath -ChildPath $fileName
          $jsonString | Out-File -FilePath $filePath
    - task: PowerShell@2
      displayName: publish oob tools
      inputs:
        targetType: 'inline'
        script: |
          Copy-Item .\tools\ModulePublisher.psd1 -Destination OOB
          Copy-Item .\tools\ModulePublisher.psm1 -Destination OOB
          Copy-Item .\tools\NuGet.exe -Destination OOB
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: OOB
        ArtifactName: OOB
- stage: Codesign
  dependsOn: OOBRelease
  jobs:

  - job: PulishForTest
    dependsOn: Release
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'OOB'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'artifacts'
        downloadPath: '$(System.ArtifactsDirectory)'
    - task: AzurePowerShell@5
      displayName: 'Push packages to storage account'
      inputs:
        azureSubscription: 'azureps-infra-sp'
        ScriptType: InlineScript
        azurePowerShellVersion: LatestVersion
        pwsh: true
        Inline: |
          $jsonFilePath = "$(System.ArtifactsDirectory)/OOB/VersionInfo.json"
          $jsonContent = Get-Content -Path $jsonFilePath -Raw
          $jsonObject = $jsonContent | ConvertFrom-Json
          $versionNumber = $jsonObject.VersionNumber
          $versionChanges = $jsonObject.VersionChanges
          $moduleName = $jsonObject.ModuleName
          $context = New-AzStorageContext -StorageAccountName "$(TestStorageAccountName)"
          $package = Get-Item "$(System.ArtifactsDirectory)/artifacts/Az.$moduleName.$versionNumber.nupkg"
          $package | Set-AzStorageBlobContent -Container "public" -Context $context -Force
- stage: publish
  jobs:
  - deployment: 
    environment: OOBPublish
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'OOB'
              downloadPath: '$(System.ArtifactsDirectory)'
          - task: DownloadBuildArtifacts@1
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'artifacts'
              downloadPath: '$(System.ArtifactsDirectory)'
          - powershell: |
              $jsonFilePath = "$(System.ArtifactsDirectory)\OOB\VersionInfo.json"
              $jsonContent = Get-Content -Path $jsonFilePath -Raw
              $jsonObject = $jsonContent | ConvertFrom-Json
              $versionNumber = $jsonObject.VersionNumber
              $versionChanges = $jsonObject.VersionChanges
              $moduleName = $jsonObject.ModuleName
              echo "##vso[task.setvariable variable=versionNumber]$versionNumber"
              echo "##vso[task.setvariable variable=versionChanges]$versionChanges"
              echo "##vso[task.setvariable variable=ModuleName]$ModuleName"
              displayName: 'Get OOB Info'
          - task: GitHubRelease@1
            displayName: 'Create GitHub release '
            inputs:
              gitHubConnection: Nickcandy
              tagSource: userSpecifiedTag
              tag: 'Az.$(ModuleName)-v$(versionNumber)'
              title: 'Az.$(ModuleName) v$(versionNumber)'
              releaseNotesSource: inline
              releaseNotesInline: |
                https://www.powershellgallery.com/packages/Az.$(ModuleName)/$(versionNumber)

                ## Version $(versionNumber)
                $(versionChanges)
              isDraft: true
              addChangeLog: false
              isPreRelease: ${{parameters.PreRelease}}


