parameters:
- name: TargetBranch
  displayName: Branch this module will generated to
  type: string
  default: main
- name: ServiceName
  displayName: Service to OOB release
  type: string
  default: Az.Databricks
- name: version
  displayName: Update verison to 
  type: string
  default: 1.0.0
resources:
  repositories:
  - repository: self
    type: git
jobs:
- job: OOBRelease
  timeoutInMinutes: 180
  pool: pool-windows-2019
  steps:
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      command: custom
      custom: msbuild
      arguments: 'build.proj /t:Clean;Build /p:Configuration=Release'
  - task: UseDotNet@2
    inputs:
      version: '3.1.x'
  - pwsh: |
        .\tools\RunVersionController.ps1 -ModuleName  
    displayName: 'Bump up version'
  - task: AzurePowerShell@5
    inputs:
        azureSubscription: 'azureps-infra-sp'
        ScriptType: 'InlineScript'
        azurePowerShellVersion: 'LatestVersion'
        inline: |
            Set-AzContext -Tenant 72f988bf-86f1-41af-91ab-2d7cd011db47 -SubscriptionId 6b085460-5f21-477e-ba44-1035046e9101
            $Token = Get-AzKeyVaultSecret -VaultName azurepsdev -Name azpsbot-github-pat -AsPlainText
            git config user.email "65331932+azure-powershell-bot@users.noreply.github.com"
            git config user.name "azure-powershell-bot"
            git checkout -b codeoob/${{ parameters.ServiceName }}
            git add -A
            git commit -m "Bump up version for ${{ parameters.ServiceName }}"
            git remote set-url origin https://azure-powershell-bot:$Token@github.com/Azure/azure-powershell.git;
            git push origin codeoob/${{ parameters.ServiceName }} --force;
            $Title = "Migrate ${{ parameters.ServiceName }} from oob to main"
            $HeadBranch = "codeoob/${{ parameters.ServiceName }}"
            $BaseBranch = "${{ parameters.TargetBranch }}"
            $Description = "Migrate ${{ parameters.ServiceName }} from oob to ${{parameters.TargetBranch}}"
            ./tools/Github/CreatePR.ps1 -Title $Title -HeadBranch $HeadBranch -BaseBranch $BaseBranch -BotAccessToken $Token -Description $Description
    displayName: Create PR to main branch
- template: ./code-sign.yml
- job: Githubrelease
  steps:
  - task: GitHubRelease@1
    inputs:
      gitHubConnection: 'Nickcandy'
      repositoryName: '$(Build.Repository.Name)'
      action: 'create'
      target: '$(Build.SourceVersion)'
      tagSource: 'userSpecifiedTag'
      tag: '${{parameters.ServiceName}}'
      releaseNotesSource: 'inline'
      releaseNotesInline: |
        https://www.powershellgallery.com/packages/${{ parameters.ServiceName }}/${{ parameters.version }}
        ## Version ${{ parameters.version }}
      assets: 
      isDraft: true
      addChangeLog: false
