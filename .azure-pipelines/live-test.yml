parameters:
  - name: GalleryName
    displayName: Gallery Name
    type: string
    default: DailyBuild
    values:
      - DailyBuild
      - Sign
      - PSGallery
  - name: PipelineBuildId
    displayName: Pipeline Build Id for Artifacts
    type: string
    default: ' '

variables:
  os_windows_2019: windows-2019
  os_windows_2022: windows-2022
  os_linux: ubuntu-latest
  os_macos: macOS-latest
  win_ps_5_1: 5.1
  ps_7_2_x: 7.2.*
  ps_7_3_x: 7.3.*
  ps_7_4_x: 7.4.*
  ps_latest: latest
  dotnet_sdk_6: 6.0.x
  dotnet_sdk_7: 7.0.x
  dotnet_sdk_8: 8.0.x
  ArtifactsName: LiveTestArtifacts
  DataLocation: $(Pipeline.Workspace)/$(ArtifactsName)
  SuppressAzurePowerShellBreakingChangeWarnings: true

schedules:
- cron: "0 19 * * *"
  displayName: Daily Live Test
  branches:
    include:
    - main
  always: true

pr: none
trigger: none

stages:
- stage: Test
  displayName: Run Live Test
  jobs:
  - template: util/live-test-steps.yml
    parameters:
      name: 'win_ps_5_1_win_2019'
      vmImage: ${{ variables.os_windows_2019 }}
      osType: 'Windows'
      psVersion: ${{ variables.win_ps_5_1 }}
      dotnetVersion: ${{ variables.dotnet_sdk_6 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'win_ps_5_1_win_2022'
      vmImage: ${{ variables.os_windows_2022 }}
      osType: 'Windows'
      psVersion: ${{ variables.win_ps_5_1 }}
      dotnetVersion: ${{ variables.dotnet_sdk_6 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_2_x_win_2019'
      vmImage: ${{ variables.os_windows_2019 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_7_2_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_6 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_3_x_win_2019'
      vmImage: ${{ variables.os_windows_2019 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_7_3_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_7 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_4_x_win_2019'
      vmImage: ${{ variables.os_windows_2019 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_7_4_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_8 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_latest_win_2019'
      vmImage: ${{ variables.os_windows_2019 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_latest }}
      dotnetVersion: ${{ variables.dotnet_sdk_8 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_2_x_win_2022'
      vmImage: ${{ variables.os_windows_2022 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_7_2_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_6 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_3_x_win_2022'
      vmImage: ${{ variables.os_windows_2022 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_7_3_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_7 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_4_x_win_2022'
      vmImage: ${{ variables.os_windows_2022 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_7_4_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_8 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_latest_win_2022'
      vmImage: ${{ variables.os_windows_2022 }}
      osType: 'Windows'
      psVersion: ${{ variables.ps_latest }}
      dotnetVersion: ${{ variables.dotnet_sdk_8 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_2_x_linux'
      vmImage: ${{ variables.os_linux }}
      osType: 'Linux'
      psVersion: ${{ variables.ps_7_2_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_6 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_3_x_linux'
      vmImage: ${{ variables.os_linux }}
      osType: 'Linux'
      psVersion: ${{ variables.ps_7_3_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_7 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_7_4_x_linux'
      vmImage: ${{ variables.os_linux }}
      osType: 'Linux'
      psVersion: ${{ variables.ps_7_4_x }}
      dotnetVersion: ${{ variables.dotnet_sdk_8 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  - template: util/live-test-steps.yml
    parameters:
      name: 'ps_latest_linux'
      vmImage: ${{ variables.os_linux }}
      osType: 'Linux'
      psVersion: ${{ variables.ps_latest }}
      dotnetVersion: ${{ variables.dotnet_sdk_8 }}
      galleryName: ${{ parameters.GalleryName }}
      pipelineBuildId: ${{ parameters.PipelineBuildId }}

  # - template: util/live-test-steps.yml
  #   parameters:
  #     name: 'ps_7_2_x_macOS'
  #     vmImage: ${{ variables.os_macos }}
  #     osType: 'MacOS'
  #     psVersion: ${{ variables.ps_7_2_x }}
  #     dotnetVersion: ${{ variables.dotnet_sdk_6 }}

  # - template: util/live-test-steps.yml
  #   parameters:
  #     name: 'ps_7_3_x_macOS'
  #     vmImage: ${{ variables.os_macos }}
  #     osType: 'MacOS'
  #     psVersion: ${{ variables.ps_7_3_x }}
  #     dotnetVersion: ${{ variables.dotnet_sdk_7 }}

  # - template: util/live-test-steps.yml
  #   parameters:
  #     name: 'ps_7_4_x_macOS'
  #     vmImage: ${{ variables.os_macos }}
  #     osType: 'MacOS'
  #     psVersion: ${{ variables.ps_7_4_x }}
  #     dotnetVersion: ${{ variables.dotnet_sdk_8 }}

  # - template: util/live-test-steps.yml
  #   parameters:
  #     name: 'ps_latest_macOS'
  #     vmImage: ${{ variables.os_macos }}
  #     osType: 'MacOS'
  #     psVersion: ${{ variables.ps_latest }}
  #     dotnetVersion: ${{ variables.dotnet_sdk_8 }}

- stage: Report
  displayName: Send Report
  condition: always()
  jobs:
  - job:
    displayName: Send Live Test Status Report
    steps:
    - task: PowerShell@2
      displayName: Create data location directory
      inputs:
        pwsh: true
        targetType: inline
        script:
          New-Item -Name $(ArtifactsName) -Path $(Pipeline.Workspace) -ItemType Directory -Force

    - task: DownloadPipelineArtifact@2
      displayName: Download live test results
      inputs:
        buildType: 'current'
        targetPath: $(DataLocation)

    - task: PowerShell@2
      displayName: Send live test report
      inputs:
        pwsh: true
        targetType: filePath
        filePath: ./tools/TestFx/Live/SendLiveTestReport.ps1
        arguments: -EmailServiceConnectionString '$(EmailServiceConnectionString)' -EmailFrom '$(EmailFrom)'

    - task: AzurePowerShell@5
      displayName: Save live test results
      condition: or(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.SourceBranch'], 'refs/heads/internal/release'))
      inputs:
        pwsh: true
        azurePowerShellVersion: latestVersion
        azureSubscription: $(KustoServiceConnectionName)
        scriptType: filePath
        scriptPath: ./tools/TestFx/Live/SaveLiveTestResult.ps1
