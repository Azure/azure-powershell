// ----------------------------------------------------------------------------------
//
// Copyright Microsoft Corporation
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
// http://www.apache.org/licenses/LICENSE-2.0
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------------------------------------------------------------

using Microsoft.Azure.Commands.Common.Authentication;
using Microsoft.Azure.Commands.Common.Authentication.Abstractions;
using Microsoft.Azure.Commands.Sql.Common;
using Microsoft.Azure.Management.Sql;
using Microsoft.Azure.Management.Sql.Models;
using Microsoft.Azure.Management.Storage;
using Microsoft.Azure.Management.Storage.Models;
using Microsoft.Rest.Azure;
using Microsoft.WindowsAzure.Storage;
using Microsoft.WindowsAzure.Storage.Blob;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;


namespace Microsoft.Azure.Commands.Sql.VulnerabilityAssessment.Services
{
    /// <summary>
    /// This class is responsible for all the REST communication with the Vulnerability Assessment REST endpoints
    /// </summary>
    public class VulnerabilityAssessmentEndpointsCommunicator
    {
        /// <summary>
        /// The Sql client to be used by this end points communicator
        /// </summary>
        private static SqlManagementClient SqlClient { get; set; }

        /// <summary>
        /// The Storage client to be used by this end points communicator
        /// </summary>
        private static StorageManagementClient StorageClient { get; set; }

        /// <summary>
        /// Gets or set the Azure subscription
        /// </summary>
        private static IAzureSubscription Subscription { get; set; }

        /// <summary>
        /// Gets or sets the Azure profile
        /// </summary>
        public IAzureContext Context { get; set; }

        public VulnerabilityAssessmentEndpointsCommunicator(IAzureContext context)
        {
            Context = context;
            if (context.Subscription != Subscription)
            {
                Subscription = context.Subscription;
                SqlClient = null;
            }
        }

        /// <summary>
        /// Gets the database Vulnerability Assessment Settings for the given database in the given database server in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessment GetDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, string databaseName)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessments.Get(resourceGroupName, serverName, databaseName);
        }

        /// <summary>
        /// Removes the database Vulnerability Assessment Settings for the given database in the given database server in the given resource group
        /// </summary>
        public void ClearDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, string databaseName)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessments.Delete(resourceGroupName, serverName, databaseName);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the database Vulnerability Assessment Settings for the given database in the given database server in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessment SetDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, string databaseName, DatabaseVulnerabilityAssessment parameters)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessments.CreateOrUpdate(resourceGroupName, serverName, databaseName, parameters);
        }

        /// <summary>
        /// Gets the database Vulnerability Assessment rule baseline for the given rule in the given database in the given database server in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessmentRuleBaseline GetDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string serverName,
            string databaseName, string ruleId, bool ruleAppliesToMaster)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessmentRuleBaselines.Get(resourceGroupName, serverName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default);
        }

        /// <summary>
        /// Removes the database Vulnerability Assessment rule baseline for the given rule in the given database in the given database server in the given resource group
        /// </summary>
        public void ClearDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string serverName, string databaseName, string ruleId,
            bool ruleAppliesToMaster)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessmentRuleBaselines.Delete(resourceGroupName, serverName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the database Vulnerability Assessment rule baseline for the given rule in the given database in the given database server in the given resource group
        /// </summary>
        public void SetDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string serverName, string databaseName, string ruleId,
            bool ruleAppliesToMaster, DatabaseVulnerabilityAssessmentRuleBaseline parameters)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessmentRuleBaselines.CreateOrUpdate(resourceGroupName, serverName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default, parameters);
        }

        /// <summary>
        /// List the Vulnerability Assessment scan records
        /// </summary>
        public List<VulnerabilityAssessmentScanRecord> ListDatabaseVulnerabilityAssessmentScanRecords(string resourceGroupName, string serverName,
            string databaseName)
        {
            return new List<VulnerabilityAssessmentScanRecord>(GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.ListByDatabase(resourceGroupName,
                serverName, databaseName));
        }

        /// <summary>
        /// Gets a Vulnerability Assessment scan records
        /// </summary>
        public VulnerabilityAssessmentScanRecord GetDatabaseVulnerabilityAssessmentScanRecord(string resourceGroupName, string serverName,
            string databaseName, string scanId)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.Get(resourceGroupName, serverName, databaseName, scanId);
        }

        /// <summary>
        /// Exports a Vulnerability Assessment scan
        /// </summary>
        public DatabaseVulnerabilityAssessmentScansExport ConvertDatabaseVulnerabilityAssessmentScan(string resourceGroupName, string serverName,
            string databaseName, string scanId)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.Export(resourceGroupName, serverName, databaseName, scanId);
        }

        /// <summary>
        /// Triggers a Vulnerability Assessment scan
        /// </summary>
        public void TriggerDatabaseVulnerabilityAssessmentScan(string resourceGroupName, string serverName,
            string databaseName, string scanId)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.InitiateScan(resourceGroupName, serverName, databaseName, scanId);
        }

        public struct StorageContainerInfo
        {
            public string StorageAccountSasKey;
            public string StorageContainerPath;
        }

        /// <summary>
        /// Create a blob storage container ad a SAS URI
        /// </summary>
        public async Task<StorageContainerInfo> CreateBlobStorageContainer(string resourceGroupName, string storageAccountName, string containerName)
        {
            StorageManagementClient storageClient = GetCurrentStorageClient();
            var storageAccountObject = storageClient.StorageAccounts.GetProperties(resourceGroupName, storageAccountName);
            var keysObject = storageClient.StorageAccounts.ListKeys(resourceGroupName, storageAccountName);

#if NETSTANDARD
            var storageAccountBlobPrimaryEndpoints = storageAccountObject.PrimaryEndpoints.Blob;
            var key = keysObject.Keys.FirstOrDefault().Value;
#else
            var storageAccountBlobPrimaryEndpoints = storageAccountObject.StorageAccount.PrimaryEndpoints.Blob;
            var key = keysObject.StorageAccountKeys.Key1;
#endif

            // Create container
            CloudStorageAccount storageAccountClient = new CloudStorageAccount(
                new WindowsAzure.Storage.Auth.StorageCredentials(
                    storageAccountName,
                    key),
                useHttps: true);
            CloudBlobClient blobClient = storageAccountClient.CreateCloudBlobClient();
            CloudBlobContainer containerReference = blobClient.GetContainerReference(containerName);

           await containerReference.CreateIfNotExistsAsync();

            // Create the SAS key for the Vulnerability Assessment engine
            // In this case no start time is specified, so the shared access signature becomes valid immediately.
            // In Addition setting SharedAccessExpiryTime to DateTimeOffset.MaxValue is the equivalent of declaring an unlimited expiration date.
            SharedAccessBlobPolicy sharedAccessPolicy = new SharedAccessBlobPolicy
            {
                SharedAccessExpiryTime = DateTimeOffset.MaxValue,
                Permissions = SharedAccessBlobPermissions.Write | SharedAccessBlobPermissions.Read | SharedAccessBlobPermissions.List
            };

            // Generate the SAS Token
            var sasToken = containerReference.GetSharedAccessSignature(sharedAccessPolicy);

            return new StorageContainerInfo
            {
                StorageAccountSasKey = sasToken,
                StorageContainerPath = string.Format("{0}{1}", storageAccountBlobPrimaryEndpoints, containerName)
            };
        }

        /// <summary>
        /// Retrieve the SQL Management client for the currently selected subscription, adding the session and request
        /// id tracing headers for the current cmdlet invocation.
        /// </summary>
        /// <returns>The SQL Management client for the currently selected subscription.</returns>
        private SqlManagementClient GetCurrentSqlClient() => SqlClient ?? (SqlClient = AzureSession.Instance.ClientFactory.CreateArmClient<SqlManagementClient>(Context, AzureEnvironment.Endpoint.ResourceManager));


        /// <summary>
        /// Lazy creation of a single instance of a storage client
        /// </summary>
        private StorageManagementClient GetCurrentStorageClient() => StorageClient ?? (StorageClient = AzureEndpointsCommunicator.GetStorageV2Client(Context));
    }
}
