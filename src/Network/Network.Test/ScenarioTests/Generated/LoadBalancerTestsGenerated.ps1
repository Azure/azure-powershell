# <auto-generated>
# Copyright (c) Microsoft and contributors.  All rights reserved.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#   http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# 
# See the License for the specific language governing permissions and
# limitations under the License.
# 
# 
# Warning: This code was generated by a tool.
# 
# Changes to this file may cause incorrect behavior and will be lost if the
# code is regenerated.
# 
# For documentation on code generator please visit
#   https://aka.ms/nrp-code-generation
# Please contact wanrpdev@microsoft.com if you need to make changes to this file.
# </auto-generated>

function Check-CmdletReturnType
{
    param($cmdletName, $cmdletReturn)

    $cmdletData = Get-Command $cmdletName;
    Assert-NotNull $cmdletData;
    [array]$cmdletReturnTypes = $cmdletData.OutputType.Name | Foreach-Object { return ($_ -replace "Microsoft.Azure.Commands.Network.Models.","") };
    [array]$cmdletReturnTypes = $cmdletReturnTypes | Foreach-Object { return ($_ -replace "System.","") };
    $realReturnType = $cmdletReturn.GetType().Name -replace "Microsoft.Azure.Commands.Network.Models.","";
    return $cmdletReturnTypes -contains $realReturnType;
}

<#
.SYNOPSIS
Test creating new LoadBalancer using minimal set of parameters
#>
function Test-LoadBalancerCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";
    $BackendAddressPoolName = "BackendAddressPoolName";
    $ProbeName = "ProbeName";
    $ProbePort = 2424;
    $ProbeIntervalInSeconds = 6;
    $ProbeProbeCount = 4;
    $InboundNatPoolName = "InboundNatPoolName";
    $InboundNatPoolProtocol = "Udp";
    $InboundNatPoolFrontendPortRangeStart = 555;
    $InboundNatPoolFrontendPortRangeEnd = 999;
    $InboundNatPoolBackendPort = 987;

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;
        $BackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolName;
        $Probe = New-AzureRmLoadBalancerProbeConfig -Name $ProbeName -Port $ProbePort -IntervalInSeconds $ProbeIntervalInSeconds -ProbeCount $ProbeProbeCount;
        $InboundNatPool = New-AzureRmLoadBalancerInboundNatPoolConfig -Name $InboundNatPoolName -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $InboundNatPoolProtocol -FrontendPortRangeStart $InboundNatPoolFrontendPortRangeStart -FrontendPortRangeEnd $InboundNatPoolFrontendPortRangeEnd -BackendPort $InboundNatPoolBackendPort;

        # Create LoadBalancer
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -Location $location -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -InboundNatPool $InboundNatPool;
        Assert-NotNull $vLoadBalancer;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancer" $vLoadBalancer };
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.Probes;
        Assert-True { $vLoadBalancer.Probes.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.InboundNatPools;
        Assert-True { $vLoadBalancer.InboundNatPools.Length -gt 0 };
        Assert-AreEqual $rname $vLoadBalancer.Name;

        # Get LoadBalancer
        $vLoadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname;
        Assert-NotNull $vLoadBalancer;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancer" $vLoadBalancer };
        Assert-AreEqual $rname $vLoadBalancer.Name;

        # Get all LoadBalancers in resource group
        $listLoadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $rgname;
        Assert-NotNull ($listLoadBalancer | Where-Object { $_.ResourceGroupName -eq $rgname -and $_.Name -eq $rname });

        # Get all LoadBalancers in subscription
        $listLoadBalancer = Get-AzureRmLoadBalancer;
        Assert-NotNull ($listLoadBalancer | Where-Object { $_.ResourceGroupName -eq $rgname -and $_.Name -eq $rname });

        # Remove LoadBalancer
        $job = Remove-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -PassThru -Force -AsJob;
        $job | Wait-Job;
        $removeLoadBalancer = $job | Receive-Job;
        Assert-AreEqual $true $removeLoadBalancer;

        # Get LoadBalancer should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname } "not found";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new LoadBalancer
#>
function Test-LoadBalancerCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Tag = @{tag1='test'};
    $Sku = "Basic";
    # Resource's parameters for Set test
    $TagSet = @{tag2='testSet'};
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";
    $BackendAddressPoolName = "BackendAddressPoolName";
    $ProbeName = "ProbeName";
    $ProbePort = 2424;
    $ProbeIntervalInSeconds = 6;
    $ProbeProbeCount = 4;
    $InboundNatPoolName = "InboundNatPoolName";
    $InboundNatPoolProtocol = "Udp";
    $InboundNatPoolFrontendPortRangeStart = 555;
    $InboundNatPoolFrontendPortRangeEnd = 999;
    $InboundNatPoolBackendPort = 987;

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;
        $BackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolName;
        $Probe = New-AzureRmLoadBalancerProbeConfig -Name $ProbeName -Port $ProbePort -IntervalInSeconds $ProbeIntervalInSeconds -ProbeCount $ProbeProbeCount;
        $InboundNatPool = New-AzureRmLoadBalancerInboundNatPoolConfig -Name $InboundNatPoolName -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $InboundNatPoolProtocol -FrontendPortRangeStart $InboundNatPoolFrontendPortRangeStart -FrontendPortRangeEnd $InboundNatPoolFrontendPortRangeEnd -BackendPort $InboundNatPoolBackendPort;

        # Create LoadBalancer
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -Location $location -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -InboundNatPool $InboundNatPool -Tag $Tag -Sku $Sku;
        Assert-NotNull $vLoadBalancer;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancer" $vLoadBalancer };
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.Probes;
        Assert-True { $vLoadBalancer.Probes.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.InboundNatPools;
        Assert-True { $vLoadBalancer.InboundNatPools.Length -gt 0 };
        Assert-AreEqual $rname $vLoadBalancer.Name;
        Assert-AreEqualObjectProperties $Tag $vLoadBalancer.Tag;
        Assert-AreEqual $Sku $vLoadBalancer.Sku.Name;

        # Get LoadBalancer
        $vLoadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname;
        Assert-NotNull $vLoadBalancer;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancer" $vLoadBalancer };
        Assert-AreEqual $rname $vLoadBalancer.Name;
        Assert-AreEqualObjectProperties $Tag $vLoadBalancer.Tag;
        Assert-AreEqual $Sku $vLoadBalancer.Sku.Name;

        # Get all LoadBalancers in resource group
        $listLoadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $rgname;
        Assert-NotNull ($listLoadBalancer | Where-Object { $_.ResourceGroupName -eq $rgname -and $_.Name -eq $rname });

        # Get all LoadBalancers in subscription
        $listLoadBalancer = Get-AzureRmLoadBalancer;
        Assert-NotNull ($listLoadBalancer | Where-Object { $_.ResourceGroupName -eq $rgname -and $_.Name -eq $rname });

        # Set LoadBalancer
        $vLoadBalancer.Tag = $TagSet;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;
        Assert-True { Check-CmdletReturnType "Set-AzureRmLoadBalancer" $vLoadBalancer };
        Assert-AreEqual $rname $vLoadBalancer.Name;
        Assert-AreEqualObjectProperties $TagSet $vLoadBalancer.Tag;

        # Get LoadBalancer
        $vLoadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname;
        Assert-NotNull $vLoadBalancer;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancer" $vLoadBalancer };
        Assert-AreEqual $rname $vLoadBalancer.Name;
        Assert-AreEqualObjectProperties $TagSet $vLoadBalancer.Tag;

        # Get all LoadBalancers in resource group
        $listLoadBalancer = Get-AzureRmLoadBalancer -ResourceGroupName $rgname;
        Assert-NotNull ($listLoadBalancer | Where-Object { $_.ResourceGroupName -eq $rgname -and $_.Name -eq $rname });

        # Get all LoadBalancers in subscription
        $listLoadBalancer = Get-AzureRmLoadBalancer;
        Assert-NotNull ($listLoadBalancer | Where-Object { $_.ResourceGroupName -eq $rgname -and $_.Name -eq $rname });

        # Remove LoadBalancer
        $job = Remove-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -PassThru -Force -AsJob;
        $job | Wait-Job;
        $removeLoadBalancer = $job | Receive-Job;
        Assert-AreEqual $true $removeLoadBalancer;

        # Get LoadBalancer should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname } "not found";

        # Set LoadBalancer should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer } "not found";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new FrontendIPConfiguration using minimal set of parameters
#>
function Test-FrontendIPConfigurationCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers" "East US 2";
    # Dependency parameters
    $SubnetName = "SubnetName";
    $SubnetAddressPrefix = "10.0.1.0/24";
    $VirtualNetworkName = "VirtualNetworkName";
    $VirtualNetworkAddressPrefix = @("10.0.0.0/8");

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -AddressPrefix $SubnetAddressPrefix;
        $VirtualNetwork = New-AzureRmVirtualNetwork -ResourceGroupName $rgname -Location $location -Name $VirtualNetworkName -Subnet $Subnet -AddressPrefix $VirtualNetworkAddressPrefix;
        if(-not $Subnet.Id)
        {
            $Subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -VirtualNetwork $VirtualNetwork;
        }

        # Create FrontendIPConfiguration
        $vFrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $rname -Subnet $Subnet;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -FrontendIPConfiguration $vFrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-AreEqual $rname $vFrontendIPConfiguration.Name;

        # Get FrontendIPConfiguration
        $vFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        Assert-AreEqual $rname $vFrontendIPConfiguration.Name;

        # Get all LoadBalancer's FrontendIPConfigurations
        $listFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listFrontendIPConfiguration | Where-Object { $_.Name -eq $rname });

        # Set FrontendIPConfiguration
        $vLoadBalancer = Set-AzureRmLoadBalancerFrontendIpConfig -Name $rname -LoadBalancer $vLoadBalancer -Subnet $Subnet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get FrontendIPConfiguration
        $vFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        Assert-AreEqual $rname $vFrontendIPConfiguration.Name;

        # Get all LoadBalancer's FrontendIPConfigurations
        $listFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listFrontendIPConfiguration | Where-Object { $_.Name -eq $rname });

        # Add FrontendIPConfiguration
        $vLoadBalancer = Add-AzureRmLoadBalancerFrontendIpConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Subnet $Subnet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get FrontendIPConfiguration
        $vFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        Assert-AreEqual $rnameAdd $vFrontendIPConfiguration.Name;

        # Get all LoadBalancer's FrontendIPConfigurations
        $listFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listFrontendIPConfiguration | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerFrontendIpConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Subnet $Subnet } "already exists";

        # Remove FrontendIPConfiguration
        $vLoadBalancer = Remove-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get FrontendIPConfiguration should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd } "Sequence contains no matching element";

        # Set FrontendIPConfiguration should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerFrontendIpConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Subnet $Subnet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new FrontendIPConfiguration
#>
function Test-FrontendIPConfigurationCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers" "East US 2";
    # Resource's parameters
    $PrivateIpAddress = "10.0.1.13";
    # Resource's parameters for Set test
    $PrivateIpAddressSet = "10.0.1.16";
    # Dependency parameters
    $SubnetName = "SubnetName";
    $SubnetAddressPrefix = "10.0.1.0/24";
    $VirtualNetworkName = "VirtualNetworkName";
    $VirtualNetworkAddressPrefix = @("10.0.0.0/8");

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -AddressPrefix $SubnetAddressPrefix;
        $VirtualNetwork = New-AzureRmVirtualNetwork -ResourceGroupName $rgname -Location $location -Name $VirtualNetworkName -Subnet $Subnet -AddressPrefix $VirtualNetworkAddressPrefix;
        if(-not $Subnet.Id)
        {
            $Subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -VirtualNetwork $VirtualNetwork;
        }

        # Create FrontendIPConfiguration
        $vFrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $rname -Subnet $Subnet -PrivateIpAddress $PrivateIpAddress;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -FrontendIPConfiguration $vFrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-AreEqual $rname $vFrontendIPConfiguration.Name;
        Assert-AreEqual $PrivateIpAddress $vFrontendIPConfiguration.PrivateIpAddress;

        # Get FrontendIPConfiguration
        $vFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        Assert-AreEqual $rname $vFrontendIPConfiguration.Name;
        Assert-AreEqual $PrivateIpAddress $vFrontendIPConfiguration.PrivateIpAddress;

        # Get all LoadBalancer's FrontendIPConfigurations
        $listFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listFrontendIPConfiguration | Where-Object { $_.Name -eq $rname });

        # Set FrontendIPConfiguration
        $vLoadBalancer = Set-AzureRmLoadBalancerFrontendIpConfig -Name $rname -LoadBalancer $vLoadBalancer -Subnet $Subnet -PrivateIpAddress $PrivateIpAddressSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get FrontendIPConfiguration
        $vFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        Assert-AreEqual $rname $vFrontendIPConfiguration.Name;
        Assert-AreEqual $PrivateIpAddressSet $vFrontendIPConfiguration.PrivateIpAddress;

        # Get all LoadBalancer's FrontendIPConfigurations
        $listFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listFrontendIPConfiguration | Where-Object { $_.Name -eq $rname });

        # Add FrontendIPConfiguration
        $vLoadBalancer = Add-AzureRmLoadBalancerFrontendIpConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Subnet $Subnet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get FrontendIPConfiguration
        $vFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vFrontendIPConfiguration;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerFrontendIpConfig" $vFrontendIPConfiguration };
        Assert-AreEqual $rnameAdd $vFrontendIPConfiguration.Name;

        # Get all LoadBalancer's FrontendIPConfigurations
        $listFrontendIPConfiguration = Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listFrontendIPConfiguration | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerFrontendIpConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Subnet $Subnet } "already exists";

        # Remove FrontendIPConfiguration
        $vLoadBalancer = Remove-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get FrontendIPConfiguration should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerFrontendIpConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd } "Sequence contains no matching element";

        # Set FrontendIPConfiguration should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerFrontendIpConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Subnet $Subnet -PrivateIpAddress $PrivateIpAddressSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new BackendAddressPool using minimal set of parameters
#>
function Test-BackendAddressPoolCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;

        # Create BackendAddressPool
        $vBackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $rname;
        Assert-NotNull $vBackendAddressPool;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerBackendAddressPoolConfig" $vBackendAddressPool };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -BackendAddressPool $vBackendAddressPool -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-AreEqual $rname $vBackendAddressPool.Name;

        # Get BackendAddressPool
        $vBackendAddressPool = Get-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vBackendAddressPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerBackendAddressPoolConfig" $vBackendAddressPool };
        Assert-AreEqual $rname $vBackendAddressPool.Name;

        # Get all LoadBalancer's BackendAddressPools
        $listBackendAddressPool = Get-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listBackendAddressPool | Where-Object { $_.Name -eq $rname });

        # Add BackendAddressPool
        $vLoadBalancer = Add-AzureRmLoadBalancerBackendAddressPoolConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get BackendAddressPool
        $vBackendAddressPool = Get-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vBackendAddressPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerBackendAddressPoolConfig" $vBackendAddressPool };
        Assert-AreEqual $rnameAdd $vBackendAddressPool.Name;

        # Get all LoadBalancer's BackendAddressPools
        $listBackendAddressPool = Get-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listBackendAddressPool | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerBackendAddressPoolConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer } "already exists";

        # Remove BackendAddressPool
        $vLoadBalancer = Remove-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get BackendAddressPool should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerBackendAddressPoolConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new LoadBalancingRule using minimal set of parameters
#>
function Test-LoadBalancingRuleCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    $FrontendPort = 1024;
    $BackendPort = 4096;
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $FrontendPortSet = 1026;
    $BackendPortSet = 4095;
    # Resource's parameters for Add test
    $ProtocolAdd = "Tcp";
    $FrontendPortAdd = 1025;
    $BackendPortAdd = 4094;
    # Dependency parameters
    $SubnetName = "SubnetName";
    $SubnetAddressPrefix = "10.0.1.0/24";
    $VirtualNetworkName = "VirtualNetworkName";
    $VirtualNetworkAddressPrefix = @("10.0.0.0/8");
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";
    $BackendAddressPoolName = "BackendAddressPoolName";
    $ProbeName = "ProbeName";
    $ProbePort = 2424;
    $ProbeIntervalInSeconds = 6;
    $ProbeProbeCount = 4;

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -AddressPrefix $SubnetAddressPrefix;
        $VirtualNetwork = New-AzureRmVirtualNetwork -ResourceGroupName $rgname -Location $location -Name $VirtualNetworkName -Subnet $Subnet -AddressPrefix $VirtualNetworkAddressPrefix;
        if(-not $Subnet.Id)
        {
            $Subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -VirtualNetwork $VirtualNetwork;
        }
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -Subnet $Subnet;
        $BackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolName;
        $Probe = New-AzureRmLoadBalancerProbeConfig -Name $ProbeName -Port $ProbePort -IntervalInSeconds $ProbeIntervalInSeconds -ProbeCount $ProbeProbeCount;

        # Create LoadBalancingRule
        $vLoadBalancingRule = New-AzureRmLoadBalancerRuleConfig -Name $rname -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $Protocol -FrontendPort $FrontendPort -BackendPort $BackendPort;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -LoadBalancingRule $vLoadBalancingRule -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.Probes;
        Assert-True { $vLoadBalancer.Probes.Length -gt 0 };
        Assert-AreEqual $rname $vLoadBalancingRule.Name;
        Assert-AreEqual $Protocol $vLoadBalancingRule.Protocol;
        Assert-AreEqual $FrontendPort $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPort $vLoadBalancingRule.BackendPort;

        # Get LoadBalancingRule
        $vLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        Assert-AreEqual $rname $vLoadBalancingRule.Name;
        Assert-AreEqual $Protocol $vLoadBalancingRule.Protocol;
        Assert-AreEqual $FrontendPort $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPort $vLoadBalancingRule.BackendPort;

        # Get all LoadBalancer's LoadBalancingRules
        $listLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listLoadBalancingRule | Where-Object { $_.Name -eq $rname });

        # Set LoadBalancingRule
        $vLoadBalancer = Set-AzureRmLoadBalancerRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolSet -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get LoadBalancingRule
        $vLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        Assert-AreEqual $rname $vLoadBalancingRule.Name;
        Assert-AreEqual $ProtocolSet $vLoadBalancingRule.Protocol;
        Assert-AreEqual $FrontendPortSet $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPortSet $vLoadBalancingRule.BackendPort;

        # Get all LoadBalancer's LoadBalancingRules
        $listLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listLoadBalancingRule | Where-Object { $_.Name -eq $rname });

        # Add LoadBalancingRule
        $vLoadBalancer = Add-AzureRmLoadBalancerRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolAdd -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get LoadBalancingRule
        $vLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        Assert-AreEqual $rnameAdd $vLoadBalancingRule.Name;
        Assert-AreEqual $ProtocolAdd $vLoadBalancingRule.Protocol;
        Assert-AreEqual $FrontendPortAdd $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPortAdd $vLoadBalancingRule.BackendPort;

        # Get all LoadBalancer's LoadBalancingRules
        $listLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listLoadBalancingRule | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolAdd -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd } "already exists";

        # Remove LoadBalancingRule
        $vLoadBalancer = Remove-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get LoadBalancingRule should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set LoadBalancingRule should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolSet -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new LoadBalancingRule
#>
function Test-LoadBalancingRuleCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    $LoadDistribution = "Default";
    $FrontendPort = 1024;
    $BackendPort = 4096;
    $IdleTimeoutInMinutes = 5;
    $EnableFloatingIP = $true;
    $EnableTcpReset = $false;
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $LoadDistributionSet = "SourceIP";
    $FrontendPortSet = 1026;
    $BackendPortSet = 4095;
    $IdleTimeoutInMinutesSet = 29;
    $EnableFloatingIPSet = $false;
    $EnableTcpResetSet = $false;
    # Resource's parameters for Add test
    $ProtocolAdd = "Tcp";
    $LoadDistributionAdd = "SourceIPProtocol";
    $FrontendPortAdd = 1025;
    $BackendPortAdd = 4094;
    $IdleTimeoutInMinutesAdd = 7;
    $EnableFloatingIPAdd = $false;
    $EnableTcpResetAdd = $false;
    # Dependency parameters
    $SubnetName = "SubnetName";
    $SubnetAddressPrefix = "10.0.1.0/24";
    $VirtualNetworkName = "VirtualNetworkName";
    $VirtualNetworkAddressPrefix = @("10.0.0.0/8");
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";
    $BackendAddressPoolName = "BackendAddressPoolName";
    $ProbeName = "ProbeName";
    $ProbePort = 2424;
    $ProbeIntervalInSeconds = 6;
    $ProbeProbeCount = 4;

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -AddressPrefix $SubnetAddressPrefix;
        $VirtualNetwork = New-AzureRmVirtualNetwork -ResourceGroupName $rgname -Location $location -Name $VirtualNetworkName -Subnet $Subnet -AddressPrefix $VirtualNetworkAddressPrefix;
        if(-not $Subnet.Id)
        {
            $Subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -VirtualNetwork $VirtualNetwork;
        }
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -Subnet $Subnet;
        $BackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolName;
        $Probe = New-AzureRmLoadBalancerProbeConfig -Name $ProbeName -Port $ProbePort -IntervalInSeconds $ProbeIntervalInSeconds -ProbeCount $ProbeProbeCount;

        # Create LoadBalancingRule
        $vLoadBalancingRule = New-AzureRmLoadBalancerRuleConfig -Name $rname -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $Protocol -LoadDistribution $LoadDistribution -FrontendPort $FrontendPort -BackendPort $BackendPort -IdleTimeoutInMinutes $IdleTimeoutInMinutes -EnableFloatingIP;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -LoadBalancingRule $vLoadBalancingRule -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.Probes;
        Assert-True { $vLoadBalancer.Probes.Length -gt 0 };
        Assert-AreEqual $rname $vLoadBalancingRule.Name;
        Assert-AreEqual $Protocol $vLoadBalancingRule.Protocol;
        Assert-AreEqual $LoadDistribution $vLoadBalancingRule.LoadDistribution;
        Assert-AreEqual $FrontendPort $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPort $vLoadBalancingRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutes $vLoadBalancingRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIP $vLoadBalancingRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpReset $vLoadBalancingRule.EnableTcpReset;

        # Get LoadBalancingRule
        $vLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        Assert-AreEqual $rname $vLoadBalancingRule.Name;
        Assert-AreEqual $Protocol $vLoadBalancingRule.Protocol;
        Assert-AreEqual $LoadDistribution $vLoadBalancingRule.LoadDistribution;
        Assert-AreEqual $FrontendPort $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPort $vLoadBalancingRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutes $vLoadBalancingRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIP $vLoadBalancingRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpReset $vLoadBalancingRule.EnableTcpReset;

        # Get all LoadBalancer's LoadBalancingRules
        $listLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listLoadBalancingRule | Where-Object { $_.Name -eq $rname });

        # Set LoadBalancingRule
        $vLoadBalancer = Set-AzureRmLoadBalancerRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolSet -LoadDistribution $LoadDistributionSet -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get LoadBalancingRule
        $vLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        Assert-AreEqual $rname $vLoadBalancingRule.Name;
        Assert-AreEqual $ProtocolSet $vLoadBalancingRule.Protocol;
        Assert-AreEqual $LoadDistributionSet $vLoadBalancingRule.LoadDistribution;
        Assert-AreEqual $FrontendPortSet $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPortSet $vLoadBalancingRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutesSet $vLoadBalancingRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIPSet $vLoadBalancingRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpResetSet $vLoadBalancingRule.EnableTcpReset;

        # Get all LoadBalancer's LoadBalancingRules
        $listLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listLoadBalancingRule | Where-Object { $_.Name -eq $rname });

        # Add LoadBalancingRule
        $vLoadBalancer = Add-AzureRmLoadBalancerRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolAdd -LoadDistribution $LoadDistributionAdd -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get LoadBalancingRule
        $vLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vLoadBalancingRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerRuleConfig" $vLoadBalancingRule };
        Assert-AreEqual $rnameAdd $vLoadBalancingRule.Name;
        Assert-AreEqual $ProtocolAdd $vLoadBalancingRule.Protocol;
        Assert-AreEqual $LoadDistributionAdd $vLoadBalancingRule.LoadDistribution;
        Assert-AreEqual $FrontendPortAdd $vLoadBalancingRule.FrontendPort;
        Assert-AreEqual $BackendPortAdd $vLoadBalancingRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutesAdd $vLoadBalancingRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIPAdd $vLoadBalancingRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpResetAdd $vLoadBalancingRule.EnableTcpReset;

        # Get all LoadBalancer's LoadBalancingRules
        $listLoadBalancingRule = Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listLoadBalancingRule | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolAdd -LoadDistribution $LoadDistributionAdd -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd } "already exists";

        # Remove LoadBalancingRule
        $vLoadBalancer = Remove-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get LoadBalancingRule should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerRuleConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set LoadBalancingRule should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Probe $Probe -Protocol $ProtocolSet -LoadDistribution $LoadDistributionSet -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new Probe using minimal set of parameters
#>
function Test-ProbeCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Port = 2424;
    $IntervalInSeconds = 6;
    $ProbeCount = 4;
    # Resource's parameters for Set test
    $PortSet = 4244;
    $IntervalInSecondsSet = 14;
    $ProbeCountSet = 7;
    # Resource's parameters for Add test
    $PortAdd = 443;
    $IntervalInSecondsAdd = 11;
    $ProbeCountAdd = 5;
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;

        # Create Probe
        $vProbe = New-AzureRmLoadBalancerProbeConfig -Name $rname -Port $Port -IntervalInSeconds $IntervalInSeconds -ProbeCount $ProbeCount;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerProbeConfig" $vProbe };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -Probe $vProbe -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-AreEqual $rname $vProbe.Name;
        Assert-AreEqual $Port $vProbe.Port;
        Assert-AreEqual $IntervalInSeconds $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCount $vProbe.NumberOfProbes;

        # Get Probe
        $vProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerProbeConfig" $vProbe };
        Assert-AreEqual $rname $vProbe.Name;
        Assert-AreEqual $Port $vProbe.Port;
        Assert-AreEqual $IntervalInSeconds $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCount $vProbe.NumberOfProbes;

        # Get all LoadBalancer's Probes
        $listProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listProbe | Where-Object { $_.Name -eq $rname });

        # Set Probe
        $vLoadBalancer = Set-AzureRmLoadBalancerProbeConfig -Name $rname -LoadBalancer $vLoadBalancer -Port $PortSet -IntervalInSeconds $IntervalInSecondsSet -ProbeCount $ProbeCountSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get Probe
        $vProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerProbeConfig" $vProbe };
        Assert-AreEqual $rname $vProbe.Name;
        Assert-AreEqual $PortSet $vProbe.Port;
        Assert-AreEqual $IntervalInSecondsSet $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCountSet $vProbe.NumberOfProbes;

        # Get all LoadBalancer's Probes
        $listProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listProbe | Where-Object { $_.Name -eq $rname });

        # Add Probe
        $vLoadBalancer = Add-AzureRmLoadBalancerProbeConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Port $PortAdd -IntervalInSeconds $IntervalInSecondsAdd -ProbeCount $ProbeCountAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get Probe
        $vProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerProbeConfig" $vProbe };
        Assert-AreEqual $rnameAdd $vProbe.Name;
        Assert-AreEqual $PortAdd $vProbe.Port;
        Assert-AreEqual $IntervalInSecondsAdd $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCountAdd $vProbe.NumberOfProbes;

        # Get all LoadBalancer's Probes
        $listProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listProbe | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerProbeConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Port $PortAdd -IntervalInSeconds $IntervalInSecondsAdd -ProbeCount $ProbeCountAdd } "already exists";

        # Remove Probe
        $vLoadBalancer = Remove-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get Probe should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set Probe should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerProbeConfig -Name $rname -LoadBalancer $vLoadBalancer -Port $PortSet -IntervalInSeconds $IntervalInSecondsSet -ProbeCount $ProbeCountSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new Probe
#>
function Test-ProbeCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Http";
    $Port = 2424;
    $IntervalInSeconds = 6;
    $ProbeCount = 4;
    $RequestPath = "/create";
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $PortSet = 4244;
    $IntervalInSecondsSet = 14;
    $ProbeCountSet = 7;
    # Resource's parameters for Add test
    $PortAdd = 443;
    $IntervalInSecondsAdd = 11;
    $ProbeCountAdd = 5;
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;

        # Create Probe
        $vProbe = New-AzureRmLoadBalancerProbeConfig -Name $rname -Protocol $Protocol -Port $Port -IntervalInSeconds $IntervalInSeconds -ProbeCount $ProbeCount -RequestPath $RequestPath;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerProbeConfig" $vProbe };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -Probe $vProbe -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-AreEqual $rname $vProbe.Name;
        Assert-AreEqual $Protocol $vProbe.Protocol;
        Assert-AreEqual $Port $vProbe.Port;
        Assert-AreEqual $IntervalInSeconds $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCount $vProbe.NumberOfProbes;
        Assert-AreEqual $RequestPath $vProbe.RequestPath;

        # Get Probe
        $vProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerProbeConfig" $vProbe };
        Assert-AreEqual $rname $vProbe.Name;
        Assert-AreEqual $Protocol $vProbe.Protocol;
        Assert-AreEqual $Port $vProbe.Port;
        Assert-AreEqual $IntervalInSeconds $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCount $vProbe.NumberOfProbes;
        Assert-AreEqual $RequestPath $vProbe.RequestPath;

        # Get all LoadBalancer's Probes
        $listProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listProbe | Where-Object { $_.Name -eq $rname });

        # Set Probe
        $vLoadBalancer = Set-AzureRmLoadBalancerProbeConfig -Name $rname -LoadBalancer $vLoadBalancer -Protocol $ProtocolSet -Port $PortSet -IntervalInSeconds $IntervalInSecondsSet -ProbeCount $ProbeCountSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get Probe
        $vProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerProbeConfig" $vProbe };
        Assert-AreEqual $rname $vProbe.Name;
        Assert-AreEqual $ProtocolSet $vProbe.Protocol;
        Assert-AreEqual $PortSet $vProbe.Port;
        Assert-AreEqual $IntervalInSecondsSet $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCountSet $vProbe.NumberOfProbes;

        # Get all LoadBalancer's Probes
        $listProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listProbe | Where-Object { $_.Name -eq $rname });

        # Add Probe
        $vLoadBalancer = Add-AzureRmLoadBalancerProbeConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Port $PortAdd -IntervalInSeconds $IntervalInSecondsAdd -ProbeCount $ProbeCountAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get Probe
        $vProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vProbe;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerProbeConfig" $vProbe };
        Assert-AreEqual $rnameAdd $vProbe.Name;
        Assert-AreEqual $PortAdd $vProbe.Port;
        Assert-AreEqual $IntervalInSecondsAdd $vProbe.IntervalInSeconds;
        Assert-AreEqual $ProbeCountAdd $vProbe.NumberOfProbes;

        # Get all LoadBalancer's Probes
        $listProbe = Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listProbe | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerProbeConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -Port $PortAdd -IntervalInSeconds $IntervalInSecondsAdd -ProbeCount $ProbeCountAdd } "already exists";

        # Remove Probe
        $vLoadBalancer = Remove-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get Probe should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerProbeConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set Probe should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerProbeConfig -Name $rname -LoadBalancer $vLoadBalancer -Protocol $ProtocolSet -Port $PortSet -IntervalInSeconds $IntervalInSecondsSet -ProbeCount $ProbeCountSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new InboundNatRule using minimal set of parameters
#>
function Test-InboundNatRuleCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $FrontendPort = 123;
    $BackendPort = 456;
    # Resource's parameters for Set test
    $FrontendPortSet = 128;
    $BackendPortSet = 500;
    # Resource's parameters for Add test
    $FrontendPortAdd = 80;
    $BackendPortAdd = 512;
    # Dependency parameters
    $SubnetName = "SubnetName";
    $SubnetAddressPrefix = "10.0.1.0/24";
    $VirtualNetworkName = "VirtualNetworkName";
    $VirtualNetworkAddressPrefix = @("10.0.0.0/8");
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -AddressPrefix $SubnetAddressPrefix;
        $VirtualNetwork = New-AzureRmVirtualNetwork -ResourceGroupName $rgname -Location $location -Name $VirtualNetworkName -Subnet $Subnet -AddressPrefix $VirtualNetworkAddressPrefix;
        if(-not $Subnet.Id)
        {
            $Subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -VirtualNetwork $VirtualNetwork;
        }
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -Subnet $Subnet;

        # Create InboundNatRule
        $vInboundNatRule = New-AzureRmLoadBalancerInboundNatRuleConfig -Name $rname -FrontendIpConfiguration $FrontendIPConfiguration -FrontendPort $FrontendPort -BackendPort $BackendPort;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -InboundNatRule $vInboundNatRule -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-AreEqual $rname $vInboundNatRule.Name;
        Assert-AreEqual $FrontendPort $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPort $vInboundNatRule.BackendPort;

        # Get InboundNatRule
        $vInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        Assert-AreEqual $rname $vInboundNatRule.Name;
        Assert-AreEqual $FrontendPort $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPort $vInboundNatRule.BackendPort;

        # Get all LoadBalancer's InboundNatRules
        $listInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatRule | Where-Object { $_.Name -eq $rname });

        # Set InboundNatRule
        $vLoadBalancer = Set-AzureRmLoadBalancerInboundNatRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatRule
        $vInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        Assert-AreEqual $rname $vInboundNatRule.Name;
        Assert-AreEqual $FrontendPortSet $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPortSet $vInboundNatRule.BackendPort;

        # Get all LoadBalancer's InboundNatRules
        $listInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatRule | Where-Object { $_.Name -eq $rname });

        # Add InboundNatRule
        $vLoadBalancer = Add-AzureRmLoadBalancerInboundNatRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatRule
        $vInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        Assert-AreEqual $rnameAdd $vInboundNatRule.Name;
        Assert-AreEqual $FrontendPortAdd $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPortAdd $vInboundNatRule.BackendPort;

        # Get all LoadBalancer's InboundNatRules
        $listInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatRule | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerInboundNatRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd } "already exists";

        # Remove InboundNatRule
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatRule should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set InboundNatRule should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerInboundNatRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new InboundNatRule
#>
function Test-InboundNatRuleCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    $FrontendPort = 123;
    $BackendPort = 456;
    $IdleTimeoutInMinutes = 7;
    $EnableFloatingIP = $true;
    $EnableTcpReset = $false;
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $FrontendPortSet = 128;
    $BackendPortSet = 500;
    $IdleTimeoutInMinutesSet = 15;
    $EnableFloatingIPSet = $false;
    $EnableTcpResetSet = $false;
    # Resource's parameters for Add test
    $ProtocolAdd = "Tcp";
    $FrontendPortAdd = 80;
    $BackendPortAdd = 512;
    $IdleTimeoutInMinutesAdd = 17;
    $EnableFloatingIPAdd = $false;
    $EnableTcpResetAdd = $false;
    # Dependency parameters
    $SubnetName = "SubnetName";
    $SubnetAddressPrefix = "10.0.1.0/24";
    $VirtualNetworkName = "VirtualNetworkName";
    $VirtualNetworkAddressPrefix = @("10.0.0.0/8");
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $Subnet = New-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -AddressPrefix $SubnetAddressPrefix;
        $VirtualNetwork = New-AzureRmVirtualNetwork -ResourceGroupName $rgname -Location $location -Name $VirtualNetworkName -Subnet $Subnet -AddressPrefix $VirtualNetworkAddressPrefix;
        if(-not $Subnet.Id)
        {
            $Subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name $SubnetName -VirtualNetwork $VirtualNetwork;
        }
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -Subnet $Subnet;

        # Create InboundNatRule
        $vInboundNatRule = New-AzureRmLoadBalancerInboundNatRuleConfig -Name $rname -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $Protocol -FrontendPort $FrontendPort -BackendPort $BackendPort -IdleTimeoutInMinutes $IdleTimeoutInMinutes -EnableFloatingIP;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -InboundNatRule $vInboundNatRule -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-AreEqual $rname $vInboundNatRule.Name;
        Assert-AreEqual $Protocol $vInboundNatRule.Protocol;
        Assert-AreEqual $FrontendPort $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPort $vInboundNatRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutes $vInboundNatRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIP $vInboundNatRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpReset $vInboundNatRule.EnableTcpReset;

        # Get InboundNatRule
        $vInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        Assert-AreEqual $rname $vInboundNatRule.Name;
        Assert-AreEqual $Protocol $vInboundNatRule.Protocol;
        Assert-AreEqual $FrontendPort $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPort $vInboundNatRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutes $vInboundNatRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIP $vInboundNatRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpReset $vInboundNatRule.EnableTcpReset;

        # Get all LoadBalancer's InboundNatRules
        $listInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatRule | Where-Object { $_.Name -eq $rname });

        # Set InboundNatRule
        $vLoadBalancer = Set-AzureRmLoadBalancerInboundNatRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolSet -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatRule
        $vInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        Assert-AreEqual $rname $vInboundNatRule.Name;
        Assert-AreEqual $ProtocolSet $vInboundNatRule.Protocol;
        Assert-AreEqual $FrontendPortSet $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPortSet $vInboundNatRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutesSet $vInboundNatRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIPSet $vInboundNatRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpResetSet $vInboundNatRule.EnableTcpReset;

        # Get all LoadBalancer's InboundNatRules
        $listInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatRule | Where-Object { $_.Name -eq $rname });

        # Add InboundNatRule
        $vLoadBalancer = Add-AzureRmLoadBalancerInboundNatRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolAdd -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatRule
        $vInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vInboundNatRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatRuleConfig" $vInboundNatRule };
        Assert-AreEqual $rnameAdd $vInboundNatRule.Name;
        Assert-AreEqual $ProtocolAdd $vInboundNatRule.Protocol;
        Assert-AreEqual $FrontendPortAdd $vInboundNatRule.FrontendPort;
        Assert-AreEqual $BackendPortAdd $vInboundNatRule.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutesAdd $vInboundNatRule.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIPAdd $vInboundNatRule.EnableFloatingIP;
        Assert-AreEqual $EnableTcpResetAdd $vInboundNatRule.EnableTcpReset;

        # Get all LoadBalancer's InboundNatRules
        $listInboundNatRule = Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatRule | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerInboundNatRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolAdd -FrontendPort $FrontendPortAdd -BackendPort $BackendPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd } "already exists";

        # Remove InboundNatRule
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatRule should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerInboundNatRuleConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set InboundNatRule should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerInboundNatRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolSet -FrontendPort $FrontendPortSet -BackendPort $BackendPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new InboundNatPool using minimal set of parameters
#>
function Test-InboundNatPoolCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    $FrontendPortRangeStart = 555;
    $FrontendPortRangeEnd = 999;
    $BackendPort = 987;
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $FrontendPortRangeStartSet = 777;
    $FrontendPortRangeEndSet = 888;
    $BackendPortSet = 789;
    # Resource's parameters for Add test
    $ProtocolAdd = "Tcp";
    $FrontendPortRangeStartAdd = 444;
    $FrontendPortRangeEndAdd = 445;
    $BackendPortAdd = 8080;
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;

        # Create InboundNatPool
        $vInboundNatPool = New-AzureRmLoadBalancerInboundNatPoolConfig -Name $rname -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $Protocol -FrontendPortRangeStart $FrontendPortRangeStart -FrontendPortRangeEnd $FrontendPortRangeEnd -BackendPort $BackendPort;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -InboundNatPool $vInboundNatPool -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-AreEqual $rname $vInboundNatPool.Name;
        Assert-AreEqual $Protocol $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStart $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEnd $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPort $vInboundNatPool.BackendPort;

        # Get InboundNatPool
        $vInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        Assert-AreEqual $rname $vInboundNatPool.Name;
        Assert-AreEqual $Protocol $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStart $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEnd $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPort $vInboundNatPool.BackendPort;

        # Get all LoadBalancer's InboundNatPools
        $listInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatPool | Where-Object { $_.Name -eq $rname });

        # Set InboundNatPool
        $vLoadBalancer = Set-AzureRmLoadBalancerInboundNatPoolConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolSet -FrontendPortRangeStart $FrontendPortRangeStartSet -FrontendPortRangeEnd $FrontendPortRangeEndSet -BackendPort $BackendPortSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatPool
        $vInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        Assert-AreEqual $rname $vInboundNatPool.Name;
        Assert-AreEqual $ProtocolSet $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStartSet $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEndSet $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPortSet $vInboundNatPool.BackendPort;

        # Get all LoadBalancer's InboundNatPools
        $listInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatPool | Where-Object { $_.Name -eq $rname });

        # Add InboundNatPool
        $vLoadBalancer = Add-AzureRmLoadBalancerInboundNatPoolConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolAdd -FrontendPortRangeStart $FrontendPortRangeStartAdd -FrontendPortRangeEnd $FrontendPortRangeEndAdd -BackendPort $BackendPortAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatPool
        $vInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        Assert-AreEqual $rnameAdd $vInboundNatPool.Name;
        Assert-AreEqual $ProtocolAdd $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStartAdd $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEndAdd $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPortAdd $vInboundNatPool.BackendPort;

        # Get all LoadBalancer's InboundNatPools
        $listInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatPool | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerInboundNatPoolConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolAdd -FrontendPortRangeStart $FrontendPortRangeStartAdd -FrontendPortRangeEnd $FrontendPortRangeEndAdd -BackendPort $BackendPortAdd } "already exists";

        # Remove InboundNatPool
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatPool should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set InboundNatPool should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerInboundNatPoolConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolSet -FrontendPortRangeStart $FrontendPortRangeStartSet -FrontendPortRangeEnd $FrontendPortRangeEndSet -BackendPort $BackendPortSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new InboundNatPool
#>
function Test-InboundNatPoolCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    $FrontendPortRangeStart = 555;
    $FrontendPortRangeEnd = 999;
    $BackendPort = 987;
    $IdleTimeoutInMinutes = 15;
    $EnableFloatingIP = $true;
    $EnableTcpReset = $false;
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $FrontendPortRangeStartSet = 777;
    $FrontendPortRangeEndSet = 888;
    $BackendPortSet = 789;
    $IdleTimeoutInMinutesSet = 30;
    $EnableFloatingIPSet = $false;
    $EnableTcpResetSet = $false;
    # Resource's parameters for Add test
    $ProtocolAdd = "Tcp";
    $FrontendPortRangeStartAdd = 444;
    $FrontendPortRangeEndAdd = 445;
    $BackendPortAdd = 8080;
    $IdleTimeoutInMinutesAdd = 5;
    $EnableFloatingIPAdd = $false;
    $EnableTcpResetAdd = $false;
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressAllocationMethod = "Static";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;

        # Create InboundNatPool
        $vInboundNatPool = New-AzureRmLoadBalancerInboundNatPoolConfig -Name $rname -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $Protocol -FrontendPortRangeStart $FrontendPortRangeStart -FrontendPortRangeEnd $FrontendPortRangeEnd -BackendPort $BackendPort -IdleTimeoutInMinutes $IdleTimeoutInMinutes -EnableFloatingIP;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -InboundNatPool $vInboundNatPool -FrontendIPConfiguration $FrontendIPConfiguration -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-AreEqual $rname $vInboundNatPool.Name;
        Assert-AreEqual $Protocol $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStart $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEnd $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPort $vInboundNatPool.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutes $vInboundNatPool.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIP $vInboundNatPool.EnableFloatingIP;
        Assert-AreEqual $EnableTcpReset $vInboundNatPool.EnableTcpReset;

        # Get InboundNatPool
        $vInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        Assert-AreEqual $rname $vInboundNatPool.Name;
        Assert-AreEqual $Protocol $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStart $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEnd $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPort $vInboundNatPool.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutes $vInboundNatPool.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIP $vInboundNatPool.EnableFloatingIP;
        Assert-AreEqual $EnableTcpReset $vInboundNatPool.EnableTcpReset;

        # Get all LoadBalancer's InboundNatPools
        $listInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatPool | Where-Object { $_.Name -eq $rname });

        # Set InboundNatPool
        $vLoadBalancer = Set-AzureRmLoadBalancerInboundNatPoolConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolSet -FrontendPortRangeStart $FrontendPortRangeStartSet -FrontendPortRangeEnd $FrontendPortRangeEndSet -BackendPort $BackendPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatPool
        $vInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        Assert-AreEqual $rname $vInboundNatPool.Name;
        Assert-AreEqual $ProtocolSet $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStartSet $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEndSet $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPortSet $vInboundNatPool.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutesSet $vInboundNatPool.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIPSet $vInboundNatPool.EnableFloatingIP;
        Assert-AreEqual $EnableTcpResetSet $vInboundNatPool.EnableTcpReset;

        # Get all LoadBalancer's InboundNatPools
        $listInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatPool | Where-Object { $_.Name -eq $rname });

        # Add InboundNatPool
        $vLoadBalancer = Add-AzureRmLoadBalancerInboundNatPoolConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolAdd -FrontendPortRangeStart $FrontendPortRangeStartAdd -FrontendPortRangeEnd $FrontendPortRangeEndAdd -BackendPort $BackendPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatPool
        $vInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vInboundNatPool;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerInboundNatPoolConfig" $vInboundNatPool };
        Assert-AreEqual $rnameAdd $vInboundNatPool.Name;
        Assert-AreEqual $ProtocolAdd $vInboundNatPool.Protocol;
        Assert-AreEqual $FrontendPortRangeStartAdd $vInboundNatPool.FrontendPortRangeStart;
        Assert-AreEqual $FrontendPortRangeEndAdd $vInboundNatPool.FrontendPortRangeEnd;
        Assert-AreEqual $BackendPortAdd $vInboundNatPool.BackendPort;
        Assert-AreEqual $IdleTimeoutInMinutesAdd $vInboundNatPool.IdleTimeoutInMinutes;
        Assert-AreEqual $EnableFloatingIPAdd $vInboundNatPool.EnableFloatingIP;
        Assert-AreEqual $EnableTcpResetAdd $vInboundNatPool.EnableTcpReset;

        # Get all LoadBalancer's InboundNatPools
        $listInboundNatPool = Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listInboundNatPool | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerInboundNatPoolConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolAdd -FrontendPortRangeStart $FrontendPortRangeStartAdd -FrontendPortRangeEnd $FrontendPortRangeEndAdd -BackendPort $BackendPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd } "already exists";

        # Remove InboundNatPool
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get InboundNatPool should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerInboundNatPoolConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set InboundNatPool should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerInboundNatPoolConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIpConfiguration $FrontendIPConfiguration -Protocol $ProtocolSet -FrontendPortRangeStart $FrontendPortRangeStartSet -FrontendPortRangeEnd $FrontendPortRangeEndSet -BackendPort $BackendPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new OutboundRule using minimal set of parameters
#>
function Test-OutboundRuleCRUDMinimalParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    # Resource's parameters for Add test
    $ProtocolAdd = "All";
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressNameAdd = "PublicIPAddressNameAdd";
    $PublicIPAddressAllocationMethod = "Static";
    $PublicIPAddressSku = "Standard";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";
    $FrontendIPConfigurationNameAdd = "FrontendIPConfigurationNameAdd";
    $BackendAddressPoolName = "BackendAddressPoolName";
    $BackendAddressPoolNameAdd = "BackendAddressPoolNameAdd";
    $LoadBalancerSku = "Standard";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod -Sku $PublicIPAddressSku;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;
        $BackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolName;
        $PublicIPAddressAdd = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressNameAdd -AllocationMethod $PublicIPAddressAllocationMethod -Sku $PublicIPAddressSku;
        $FrontendIPConfigurationAdd = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationNameAdd -PublicIpAddress $PublicIPAddressAdd;
        $BackendAddressPoolAdd = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolNameAdd;

        # Create OutboundRule
        $vOutboundRule = New-AzureRmLoadBalancerOutboundRuleConfig -Name $rname -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Protocol $Protocol;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -OutboundRule $vOutboundRule -Sku $LoadBalancerSku -FrontendIPConfiguration @($FrontendIPConfiguration, $FrontendIPConfigurationAdd) -BackendAddressPool @($BackendAddressPool, $BackendAddressPoolAdd) -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };
        Assert-AreEqual $rname $vOutboundRule.Name;
        Assert-AreEqual $Protocol $vOutboundRule.Protocol;

        # Get OutboundRule
        $vOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        Assert-AreEqual $rname $vOutboundRule.Name;
        Assert-AreEqual $Protocol $vOutboundRule.Protocol;

        # Get all LoadBalancer's OutboundRules
        $listOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listOutboundRule | Where-Object { $_.Name -eq $rname });

        # Set OutboundRule
        $vLoadBalancer = Set-AzureRmLoadBalancerOutboundRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Protocol $ProtocolSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get OutboundRule
        $vOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        Assert-AreEqual $rname $vOutboundRule.Name;
        Assert-AreEqual $ProtocolSet $vOutboundRule.Protocol;

        # Get all LoadBalancer's OutboundRules
        $listOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listOutboundRule | Where-Object { $_.Name -eq $rname });

        # Add OutboundRule
        $vLoadBalancer = Add-AzureRmLoadBalancerOutboundRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfigurationAdd -BackendAddressPool $BackendAddressPoolAdd -Protocol $ProtocolAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };

        # Get OutboundRule
        $vOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        Assert-AreEqual $rnameAdd $vOutboundRule.Name;
        Assert-AreEqual $ProtocolAdd $vOutboundRule.Protocol;

        # Get all LoadBalancer's OutboundRules
        $listOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listOutboundRule | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerOutboundRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfigurationAdd -BackendAddressPool $BackendAddressPoolAdd -Protocol $ProtocolAdd } "already exists";

        # Remove OutboundRule
        $vLoadBalancer = Remove-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get OutboundRule should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set OutboundRule should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerOutboundRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Protocol $ProtocolSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}

<#
.SYNOPSIS
Test creating new OutboundRule
#>
function Test-OutboundRuleCRUDAllParameters
{
    # Setup
    $rgname = Get-ResourceGroupName;
    $rglocation = Get-ProviderLocation ResourceManagement;
    $rname = Get-ResourceName;
    $rnameAdd = "${rname}Add";
    $location = Get-ProviderLocation "Microsoft.Network/loadBalancers";
    # Resource's parameters
    $Protocol = "Udp";
    $AllocatedOutboundPort = 8;
    $EnableTcpReset = $false;
    $IdleTimeoutInMinutes = 15;
    # Resource's parameters for Set test
    $ProtocolSet = "Tcp";
    $AllocatedOutboundPortSet = 16;
    $EnableTcpResetSet = $false;
    $IdleTimeoutInMinutesSet = 20;
    # Resource's parameters for Add test
    $ProtocolAdd = "All";
    $AllocatedOutboundPortAdd = 24;
    $EnableTcpResetAdd = $false;
    $IdleTimeoutInMinutesAdd = 30;
    # Dependency parameters
    $PublicIPAddressName = "PublicIPAddressName";
    $PublicIPAddressNameAdd = "PublicIPAddressNameAdd";
    $PublicIPAddressAllocationMethod = "Static";
    $PublicIPAddressSku = "Standard";
    $FrontendIPConfigurationName = "FrontendIPConfigurationName";
    $FrontendIPConfigurationNameAdd = "FrontendIPConfigurationNameAdd";
    $BackendAddressPoolName = "BackendAddressPoolName";
    $BackendAddressPoolNameAdd = "BackendAddressPoolNameAdd";
    $LoadBalancerSku = "Standard";

    try
    {
        $resourceGroup = New-AzureRmResourceGroup -Name $rgname -Location $rglocation;

        # Create required dependencies
        $PublicIPAddress = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressName -AllocationMethod $PublicIPAddressAllocationMethod -Sku $PublicIPAddressSku;
        $FrontendIPConfiguration = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationName -PublicIpAddress $PublicIPAddress;
        $BackendAddressPool = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolName;
        $PublicIPAddressAdd = New-AzureRmPublicIPAddress -ResourceGroupName $rgname -Location $location -Name $PublicIPAddressNameAdd -AllocationMethod $PublicIPAddressAllocationMethod -Sku $PublicIPAddressSku;
        $FrontendIPConfigurationAdd = New-AzureRmLoadBalancerFrontendIpConfig -Name $FrontendIPConfigurationNameAdd -PublicIpAddress $PublicIPAddressAdd;
        $BackendAddressPoolAdd = New-AzureRmLoadBalancerBackendAddressPoolConfig -Name $BackendAddressPoolNameAdd;

        # Create OutboundRule
        $vOutboundRule = New-AzureRmLoadBalancerOutboundRuleConfig -Name $rname -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Protocol $Protocol -AllocatedOutboundPort $AllocatedOutboundPort -IdleTimeoutInMinutes $IdleTimeoutInMinutes;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "New-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        $vLoadBalancer = New-AzureRmLoadBalancer -ResourceGroupName $rgname -Name $rname -OutboundRule $vOutboundRule -Sku $LoadBalancerSku -FrontendIPConfiguration @($FrontendIPConfiguration, $FrontendIPConfigurationAdd) -BackendAddressPool @($BackendAddressPool, $BackendAddressPoolAdd) -Location $location;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };
        Assert-AreEqual $rname $vOutboundRule.Name;
        Assert-AreEqual $Protocol $vOutboundRule.Protocol;
        Assert-AreEqual $AllocatedOutboundPort $vOutboundRule.AllocatedOutboundPorts;
        Assert-AreEqual $EnableTcpReset $vOutboundRule.EnableTcpReset;
        Assert-AreEqual $IdleTimeoutInMinutes $vOutboundRule.IdleTimeoutInMinutes;

        # Get OutboundRule
        $vOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        Assert-AreEqual $rname $vOutboundRule.Name;
        Assert-AreEqual $Protocol $vOutboundRule.Protocol;
        Assert-AreEqual $AllocatedOutboundPort $vOutboundRule.AllocatedOutboundPorts;
        Assert-AreEqual $EnableTcpReset $vOutboundRule.EnableTcpReset;
        Assert-AreEqual $IdleTimeoutInMinutes $vOutboundRule.IdleTimeoutInMinutes;

        # Get all LoadBalancer's OutboundRules
        $listOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listOutboundRule | Where-Object { $_.Name -eq $rname });

        # Set OutboundRule
        $vLoadBalancer = Set-AzureRmLoadBalancerOutboundRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Protocol $ProtocolSet -AllocatedOutboundPort $AllocatedOutboundPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get OutboundRule
        $vOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        Assert-AreEqual $rname $vOutboundRule.Name;
        Assert-AreEqual $ProtocolSet $vOutboundRule.Protocol;
        Assert-AreEqual $AllocatedOutboundPortSet $vOutboundRule.AllocatedOutboundPorts;
        Assert-AreEqual $EnableTcpResetSet $vOutboundRule.EnableTcpReset;
        Assert-AreEqual $IdleTimeoutInMinutesSet $vOutboundRule.IdleTimeoutInMinutes;

        # Get all LoadBalancer's OutboundRules
        $listOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listOutboundRule | Where-Object { $_.Name -eq $rname });

        # Add OutboundRule
        $vLoadBalancer = Add-AzureRmLoadBalancerOutboundRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfigurationAdd -BackendAddressPool $BackendAddressPoolAdd -Protocol $ProtocolAdd -AllocatedOutboundPort $AllocatedOutboundPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd;
        Assert-NotNull $vLoadBalancer;
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;
        Assert-NotNull $vLoadBalancer.FrontendIpConfigurations;
        Assert-True { $vLoadBalancer.FrontendIpConfigurations.Length -gt 0 };
        Assert-NotNull $vLoadBalancer.BackendAddressPools;
        Assert-True { $vLoadBalancer.BackendAddressPools.Length -gt 0 };

        # Get OutboundRule
        $vOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        Assert-NotNull $vOutboundRule;
        Assert-True { Check-CmdletReturnType "Get-AzureRmLoadBalancerOutboundRuleConfig" $vOutboundRule };
        Assert-AreEqual $rnameAdd $vOutboundRule.Name;
        Assert-AreEqual $ProtocolAdd $vOutboundRule.Protocol;
        Assert-AreEqual $AllocatedOutboundPortAdd $vOutboundRule.AllocatedOutboundPorts;
        Assert-AreEqual $EnableTcpResetAdd $vOutboundRule.EnableTcpReset;
        Assert-AreEqual $IdleTimeoutInMinutesAdd $vOutboundRule.IdleTimeoutInMinutes;

        # Get all LoadBalancer's OutboundRules
        $listOutboundRule = Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer;
        Assert-NotNull ($listOutboundRule | Where-Object { $_.Name -eq $rnameAdd });

        # Try Add again
        Assert-ThrowsContains { Add-AzureRmLoadBalancerOutboundRuleConfig -Name $rnameAdd -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfigurationAdd -BackendAddressPool $BackendAddressPoolAdd -Protocol $ProtocolAdd -AllocatedOutboundPort $AllocatedOutboundPortAdd -IdleTimeoutInMinutes $IdleTimeoutInMinutesAdd } "already exists";

        # Remove OutboundRule
        $vLoadBalancer = Remove-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rnameAdd;
        $vLoadBalancer = Remove-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Additional call to test handling of already deleted subresource
        $vLoadBalancer = Remove-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname;
        # Update parent resource
        $vLoadBalancer = Set-AzureRmLoadBalancer -LoadBalancer $vLoadBalancer;
        Assert-NotNull $vLoadBalancer;

        # Get OutboundRule should fail
        Assert-ThrowsContains { Get-AzureRmLoadBalancerOutboundRuleConfig -LoadBalancer $vLoadBalancer -Name $rname } "Sequence contains no matching element";

        # Set OutboundRule should fail
        Assert-ThrowsContains { Set-AzureRmLoadBalancerOutboundRuleConfig -Name $rname -LoadBalancer $vLoadBalancer -FrontendIPConfiguration $FrontendIPConfiguration -BackendAddressPool $BackendAddressPool -Protocol $ProtocolSet -AllocatedOutboundPort $AllocatedOutboundPortSet -IdleTimeoutInMinutes $IdleTimeoutInMinutesSet } "does not exist";
    }
    finally
    {
        # Cleanup
        Clean-ResourceGroup $rgname;
    }
}
