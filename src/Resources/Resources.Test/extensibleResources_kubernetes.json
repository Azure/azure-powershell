{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "1.9-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_EXPERIMENTAL_WARNING": "Symbolic name support in ARM is experimental, and should be enabled for testing purposes only. Do not enable this setting for any production usage, or you may be unexpectedly broken at any time!",
    "_generator": {
      "name": "bicep",
      "version": "dev",
      "templateHash": "12621916361753458827"
    }
  },
  "parameters": {
    "kubeConfig": {
      "type": "secureString"
    }
  },
  "variables": {
    "backName": "azure-vote-back",
    "backPort": 6379,
    "frontName": "azure-vote-front",
    "frontPort": 80
  },
  "imports": {
    "k8s": {
      "provider": "Kubernetes",
      "version": "1.0",
      "config": {
        "kubeConfig": "[parameters('kubeConfig')]",
        "namespace": "default"
      }
    }
  },
  "resources": {
    "backDeploy": {
      "import": "k8s",
      "type": "apps/Deployment@v1",
      "properties": {
        "metadata": {
          "name": "[variables('backName')]"
        },
        "spec": {
          "replicas": 1,
          "selector": {
            "matchLabels": {
              "app": "[variables('backName')]"
            }
          },
          "template": {
            "metadata": {
              "labels": {
                "app": "[variables('backName')]"
              }
            },
            "spec": {
              "containers": [
                {
                  "name": "[variables('backName')]",
                  "image": "mcr.microsoft.com/oss/bitnami/redis:6.0.8",
                  "env": [
                    {
                      "name": "ALLOW_EMPTY_PASSWORD",
                      "value": "yes"
                    }
                  ],
                  "resources": {
                    "requests": {
                      "cpu": "100m",
                      "memory": "128Mi"
                    },
                    "limits": {
                      "cpu": "250m",
                      "memory": "256Mi"
                    }
                  },
                  "ports": [
                    {
                      "containerPort": "[variables('backPort')]",
                      "name": "redis"
                    }
                  ]
                }
              ]
            }
          }
        }
      },
      "metadata": {
        "description": "Application back-end deployment (redis)"
      }
    },
    "backSvc": {
      "import": "k8s",
      "type": "core/Service@v1",
      "properties": {
        "metadata": {
          "name": "[variables('backName')]"
        },
        "spec": {
          "ports": [
            {
              "port": "[variables('backPort')]"
            }
          ],
          "selector": {
            "app": "[variables('backName')]"
          }
        }
      },
      "metadata": {
        "description": "Configure back-end service"
      }
    },
    "frontDeploy": {
      "import": "k8s",
      "type": "apps/Deployment@v1",
      "properties": {
        "metadata": {
          "name": "[variables('frontName')]"
        },
        "spec": {
          "replicas": 1,
          "selector": {
            "matchLabels": {
              "app": "[variables('frontName')]"
            }
          },
          "template": {
            "metadata": {
              "labels": {
                "app": "[variables('frontName')]"
              }
            },
            "spec": {
              "nodeSelector": {
                "beta.kubernetes.io/os": "linux"
              },
              "containers": [
                {
                  "name": "[variables('frontName')]",
                  "image": "mcr.microsoft.com/azuredocs/azure-vote-front:v1",
                  "resources": {
                    "requests": {
                      "cpu": "100m",
                      "memory": "128Mi"
                    },
                    "limits": {
                      "cpu": "250m",
                      "memory": "256Mi"
                    }
                  },
                  "ports": [
                    {
                      "containerPort": "[variables('frontPort')]"
                    }
                  ],
                  "env": [
                    {
                      "name": "REDIS",
                      "value": "[variables('backName')]"
                    }
                  ]
                }
              ]
            }
          }
        }
      },
      "metadata": {
        "description": "Application front-end deployment (website)"
      }
    },
    "frontSvc": {
      "import": "k8s",
      "type": "core/Service@v1",
      "properties": {
        "metadata": {
          "name": "[variables('frontName')]"
        },
        "spec": {
          "type": "LoadBalancer",
          "ports": [
            {
              "port": "[variables('frontPort')]"
            }
          ],
          "selector": {
            "app": "[variables('frontName')]"
          }
        }
      },
      "metadata": {
        "description": "Configure front-end service"
      }
    }
  }
}