# Develpoing ConnectedKubernetes Powershell Cmdlets
> These notes are intended to compliment and extend the common instructions for this process.  If you spot a sensible common location where part of this document could live, please do move the information out of here.

# Overview
## Why Custom Cmdlets?
Powerhsll cmdlets can be created almost totally automatically for many products but ConnectedKubernetes is special.  The standard cmdlet interations are one or more ([Swagger]) REST API exchanges with Azure but ConnectedKubernetes also has to install Azure Arc support into a Kubernetes cluster and this requires work to be performed using [helm].

For this reason, the ConnectedKubernetes cmdlets have two or more steps such as:
- Interact with Azure using the REST APIs; this often involves just calling the autogenerated cmdlets
- Now interact with Kubernetes using [helm].

## (Part) Autogeneration Process
The autogeneration process uses [autorest.powershell], an [autorest] extension for creating Powershell cmdlets based on a (Swagger) REST API definition.  this is typically as follows:

1. Carefully craft your [Swagger] definition of the REST API
1. Read the [Quickstart for Azure PowerShell development using code generator]
1. Clone the [azure-powershell] repo
1. Create a develpoment branch based on the `generate` branch **and not based on `main`**!
1. Run the [autorest] Docker image; if you have no local image for [autorest], refer to 
1. Run [autorest] to generate configuration and files that will result in the autogenerated cmdlets
1. Run the build process (`pwsh build-module.ps1`) which completes the build process.

### Building the [autorest] Docker image
> Do **NOT** build an [autorest] image based on the Dockerfile contained in the `tools/autorest` directory below the [azure-powershell] repo as this does not produce a working image!

- Clone the [autorest.powershell] repo
- Navigate to the `tools/docker` directory
- Follow the instructions in the README file in that directory 

## Special Aspects for ConnectedKubernetes
The autogenerated cmdlets are created in C# with Powershell wrappers that are placed into the `internal` folder.  This is because we are **NOT** exposing the autogenerated functions to the user, rather er export our custom versions.
> As described earlier, the custom versions often call-through to the autogenerated version to perform the ARM REST API portion of their work.

### Gotchas
#### You Want a New Cmdlet?
If you are creating a whole new command, then you need to get the [autorest] process and the build process to work together to create the underlying `internal` command for you and this is not trivial.

When we tried to add the `Set-` cmdlet, we found it never appeared but eventually we discovered these nuggets of knowledge.
- [autorest] will look at the `operationId` field in the [Swagger] for each REST API method and determine what commands to create.  So in our case `ConnectedCluster_Create` only causes `New-` cmdlets to be created and we had to update the [Swagger] to say `ConnectedCluster_CreateOrUpdate` before any `Set-` cmdlets were created
- The `internal` cmdlets are really just Powershell wrappers but these are not created until the `pwsh build-module-ps1` step
- Between the steps above sits the [autorest] configuration found in the XML at the end of [README.md].  This does stuff like:
   - Stops the generation of various versions of cmdlets that are not required
   - **hides** the autogenerated cmdlets, which is what causes them to be created in `internal`; we had to add `set` to the list of cmdlets so hidden before the `internal` `Set-` cmdlet appeared.

[autorest.powershell]: https://github.com/Azure/autorest.powershell
[autorest]: https://github.com/Azure/autorest
[helm]: https://helm.sh/
[Swagger]: https://swagger.io/
[README.md]: ./README.md
[Quickstart for Azure PowerShell development using code generator]: https://eng.ms/docs/cloud-ai-platform/azure-core/azure-management-and-platforms/control-plane-bburns/azure-cli-tools-azure-cli-powershell-and-terraform/azure-cli-tools/onboarding/azurepowershell/quickstart_codegen
[azure-powershell]: https://github.com/azure/azure-powershell