# ----------------------------------------------------------------------------------
#
# Copyright Microsoft Corporation
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ----------------------------------------------------------------------------------

<#
.SYNOPSIS
Enables and disables ATP policy using a full resource id.
#>
function Test-AzSecuritySqlVulnerabilityAssessment
{
	# Setup
	$testPrefix = "pssqlva"
	$testParams = Get-SqlVulnerabilityAssessmentTestEnvironmentParameters $testPrefix
	$vmResourceId = "/subscriptions/" + $testParams.subscriptionId + "/resourceGroups/" + $testParams.rgName + "/providers/Microsoft.Compute/VirtualMachines/" + $testParams.sqlVmNamePrefix
	Create-TestEnvironmentWithParams $testParams

	$vaScanRecord = Get-AzSqlVulnerabilityAssessmentScanRecord -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -ScanId latest
	$resultsOnMaster = Get-AzSqlVulnerabilityAssessmentScanResult -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master
	$resultsWithFindingsOnMaster = $resultsOnMaster | where { $_.Status -eq "Finding" } 

	Assert-True ($resultsOnMaster.Count -eq $vaScanRecord.TotalRulesCount)
	Assert-True $resultsWithFindingsOnMaster.Count -eq $vaScanRecord.TotalFailedRulesCount

	$finding = $resultsWithFindingsOnMaster | select -first 1
	$ruleResult = Get-AzSqlVulnerabilityAssessmentScanResult -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -ScanId $vaScanRecord.Name -RuleId $finding.Name

	Assert-True $finding -eq $ruleResult

	# check add baseline with latest.
	Add-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -RuleId $finding.Name

	$baseline = Get-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -RuleId $finding.Name 
	
	Assert-NotNull $baseline

	$basline | Remove-AzSqlVulnerabilityAssessmentBaselineRule

	Assert-Throws {Get-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -RuleId $finding.Name }

	# check Add baseline with result
	Add-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master  -RuleId $finding.Name -Baseline $finding.QueryResults

	$baseline = Get-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master  -RuleId $finding.Name 
	Assert-NotNull $baseline

	$basline | Remove-AzSqlVulnerabilityAssessmentBaselineRule

	### Check piping

	$resultsOnMsdb = Get-AzSqlVulnerabilityAssessmentScanResult -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database msdb
	$resultsWithFindingsOnMsdb = $resultsOnMsdb | where { $_.Status -eq "Finding" } 
	$rulesNamesOnMsdb = $resultsWithFindingsOnMsdb | select -ExpandProperty Name
	$rulesNamesOnMaster = $resultsWithFindingsOnMaster | select -ExpandProperty Name

	# get rules intersection between master and msdb
	$ruleWithFindingsOnBothDbs = $rulesNamesOnMaster | ? {$rulesNamesOnMsdb -contains $_}

	if ($ruleWithFindingsOnBothDbs.Count -gt 0)
	{
		# add baseline on master 
		Add-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -RuleId $ruleWithFindingsOnBothDbs[0]
		
		# bypass it to msdb
		Get-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -RuleId $ruleWithFindingsOnBothDbs[0] `
		| Add-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database msdb

		$baseline = Get-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database msdb  -RuleId $ruleWithFindingsOnBothDbs[0]
		Assert-NotNull $baseline
	}

	# Set all latest results as Baseline
	Set-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master
	$vaScanRecord = Get-AzSqlVulnerabilityAssessmentScanRecord -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -ScanId latest
	
	Assert-True $vaScanRecord.State -eq "Passed"
	Assert-True $vaScanRecord.TotalFailedRulesCount -eq 0

	Get-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master | Remove-AzSqlVulnerabilityAssessmentBaselineRule

	$baselineSet = @{}
	$resultsWithFindingsOnMaster | select -skip 3 |  ForEach-Object { $baselineSet.Add($_.RuleId, $_.QueryResults)} 

	Set-AzSqlVulnerabilityAssessmentBaselineRule -ResourceId $vmResourceId -WorkspaceId $testParams.worspaceId -Server $testParams.sqlServerName -Database master -BaselineSet $baselineSet
}

<#
.SYNOPSIS
Gets the values of the parameters used at the tests
#>
function Get-SqlVulnerabilityAssessmentTestEnvironmentParameters ($testPrefix)
{
	return @{ subscriptionId =  (Get-AzContext).Subscription.Id;
			rgName = getAssetName ($testPrefix);
			sqlVmNamePrefix =  getAssetName ($testPrefix +'pssqlvm');
			sqlVmDomain_prefix = 'domainvm';
			sqlVmMaxLength = 15;
			sqlVmUserName = "ahabas";
			sqlVmPassword = "dsrFsdh34t78eHio";
			sqlServerImage = 'MicrosoftSQLServer:SQL2017-WS2016:Enterprise:latest';
			sqlServerVmSize = 'Standard_DS2_v2';
			sqlServerName = "MSSQLSERVER"
			operationalInsightsWorkspaceName = getAssetName ($testPrefix +"psWorkspace");
			worspaceId = "";
			location = Get-Location "Microsoft.Resources" "resourceGroups" "eastus2euap"
			}

}

	<#
.SYNOPSIS
Creates the basic test environment needed to perform the sql vulnerability assessment tests - resource group, VM, workspace,... etc
#>
function Create-TestEnvironmentWithParams ($testParams)
{
	# Create a new resource group.
	New-AzResourceGroup -Name $testParams.rgName -Location $testParams.location

	$passWord = ConvertTo-SecureString -String $testParams.sqlVmPassword -AsPlainText -Force
	$cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $testParams.sqlVmUserName, $passWord

	# Create the sql virtual machine.
	Write-Host  "ResourceGroupName " + $testParams.rgName + " -Location " + $testParams.location " -Size "+ $testParams.sqlServerVmSize + " -Image " + $testParams.sqlServerImage + " -Credential " + $cred " -Name " + $testParams.sqlVmNamePrefix
	New-AzVm -ResourceGroupName "ahabastesting" -Location eastus2euap -Size 'Standard_DS2_v2' -Image 'MicrosoftSQLServer:SQL2017-WS2016:Enterprise:latest' -Credential $cred -Name ahabastbd1vm
	#New-AzVm -ResourceGroupName $testParams.rgName -Location $testParams.location -Image $testParams.sqlServerImage -Credential $cred -Name $testParams.sqlVmNamePrefix

	# Create the log analytics worskspace 
	$workspace = New-AzOperationalInsightsWorkspace -Location $testParams.location -Name $testParams.operationalInsightsWorkspaceName -ResourceGroupName $testParams.rgName
	New-AzMonitorLogAnalyticsSolution -Type SQLVulnerabilityAssessment -ResourceGroupName $testParams.rgName -Location $testParams.location -WorkspaceResourceId $workspace.ResourceId

	# Install microsoft Monitoring agent on the VM 
	$workspaceKeys = Get-AzOperationalInsightsWorkspaceSharedKey -Name $testParams.operationalInsightsWorkspaceName -ResourceGroupName $testParams.rgName
	$publicSettings = @{"workspaceId" = $workspace.CustomerId}
	$protectedSettings = @{"workspaceKey" = $workspaceKeys.PrimarySharedKey}

	$testParams.workspaceId = $workspace.CustomerId;

	Set-AzVMExtension -ExtensionName "MicrosoftMonitoringAgent" `
     -ResourceGroupName $testParams.rgName `
     -VMName $testParams.sqlVmNamePrefix`
     -Publisher "Microsoft.EnterpriseCloud.Monitoring" `
     -ExtensionType "MicrosoftMonitoringAgent" `
     -TypeHandlerVersion 1.0 `
     -Settings $publicSettings `
     -ProtectedSettings $protectedSettings `
     -Location $testParams.location

	 # Update the registery and restart the Monitoring agent to force a scan.
	 Invoke-AzVMRunCommand -ResourceGroupName $testParams.rgName -Name $testParams.sqlVmNamePrefix -CommandId 'RunPowerShellScript' -ScriptPath 'C:\tmp\SetUpVM.ps1'

	 Start-Sleep -Seconds 180

}