// ----------------------------------------------------------------------------------
//
// Copyright Microsoft Corporation
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
// http://www.apache.org/licenses/LICENSE-2.0
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
// ----------------------------------------------------------------------------------

using Microsoft.Azure.Commands.Common.Authentication;
using Microsoft.Azure.Commands.Common.Authentication.Abstractions;
using Microsoft.Azure.Commands.Sql.Common;
using Microsoft.Azure.Management.Sql;
using Microsoft.Azure.Management.Sql.Models;
using Microsoft.Azure.Management.Storage.Version2017_10_01;
// TODO: Remove IfDef code
#if !NETSTANDARD
using Microsoft.WindowsAzure.Storage;
using Microsoft.WindowsAzure.Storage.Blob;
using System;
#endif
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Microsoft.Azure.Commands.Sql.VulnerabilityAssessment.Services
{
    /// <summary>
    /// This class is responsible for all the REST communication with the Vulnerability Assessment REST endpoints
    /// </summary>
    public class VulnerabilityAssessmentEndpointsCommunicator
    {
        /// <summary>
        /// The Sql client to be used by this end points communicator
        /// </summary>
        private static SqlManagementClient SqlClient { get; set; }

        /// <summary>
        /// The Storage client to be used by this end points communicator
        /// </summary>
        private static StorageManagementClient StorageClient { get; set; }

        /// <summary>
        /// Gets or set the Azure subscription
        /// </summary>
        private static IAzureSubscription Subscription { get; set; }

        /// <summary>
        /// Gets or sets the Azure profile
        /// </summary>
        public IAzureContext Context { get; set; }

        public VulnerabilityAssessmentEndpointsCommunicator(IAzureContext context)
        {
            Context = context;
            if (context?.Subscription != Subscription)
            {
                Subscription = context?.Subscription;
                SqlClient = null;
                StorageClient = null;
            }
        }

        /// <summary>
        /// Gets the database Vulnerability Assessment Settings for the given database in the given database server in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessment GetDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, string databaseName)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessments.Get(resourceGroupName, serverName, databaseName);
        }

        /// <summary>
        /// Gets the managed database Vulnerability Assessment Settings for the given managed database in the given managed instance in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessment GetManagedDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string managedInstanceName, string databaseName)
        {
            return GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessments.Get(resourceGroupName, managedInstanceName, databaseName);
        }

        /// <summary>
        /// Gets the server Vulnerability Assessment Settings for the given server in the given resource group
        /// </summary>
        public ServerVulnerabilityAssessment GetServerVulnerabilityAssessmentSettings(string resourceGroupName, string serverName)
        {
            return GetCurrentSqlClient().ServerVulnerabilityAssessments.Get(resourceGroupName, serverName);
        }

        /// <summary>
        /// Gets the managed instance Vulnerability Assessment Settings for the given managed instance in the given resource group
        /// </summary>
        public ManagedInstanceVulnerabilityAssessment GetManagedInstanceVulnerabilityAssessmentSettings(string resourceGroupName, string managedInstanceName)
        {
            return GetCurrentSqlClient().ManagedInstanceVulnerabilityAssessments.Get(resourceGroupName, managedInstanceName);
        }

        /// <summary>
        /// Removes the database Vulnerability Assessment Settings for the given database in the given database server in the given resource group
        /// </summary>
        public void ClearDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, string databaseName)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessments.Delete(resourceGroupName, serverName, databaseName);
        }

        /// <summary>
        /// Removes the managed database Vulnerability Assessment Settings for the given managed database in the given managed instance in the given resource group
        /// </summary>
        public void ClearManagedDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string managedInstanceName, string databaseName)
        {
            GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessments.Delete(resourceGroupName, managedInstanceName, databaseName);
        }

        /// <summary>
        /// Removes the server Vulnerability Assessment Settings for the given server in the given resource group
        /// </summary>
        public void ClearServerVulnerabilityAssessmentSettings(string resourceGroupName, string serverName)
        {
            GetCurrentSqlClient().ServerVulnerabilityAssessments.Delete(resourceGroupName, serverName);
        }

        /// <summary>
        /// Removes the managed instance Vulnerability Assessment Settings for the given managed instance in the given resource group
        /// </summary>
        public void ClearManagedInstanceVulnerabilityAssessmentSettings(string resourceGroupName, string managedInstanceName)
        {
            GetCurrentSqlClient().ManagedInstanceVulnerabilityAssessments.Delete(resourceGroupName, managedInstanceName);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the database Vulnerability Assessment Settings for the given database in the given database server in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessment SetDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, string databaseName, DatabaseVulnerabilityAssessment parameters)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessments.CreateOrUpdate(resourceGroupName, serverName, databaseName, parameters);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the managed database Vulnerability Assessment Settings for the given managed database in the given managed instance in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessment SetManagedDatabaseVulnerabilityAssessmentSettings(string resourceGroupName, string managedInstanceName, string databaseName, DatabaseVulnerabilityAssessment parameters)
        {
            return GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessments.CreateOrUpdate(resourceGroupName, managedInstanceName, databaseName, parameters);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the server Vulnerability Assessment Settings for the given server in the given resource group
        /// </summary>
        public ServerVulnerabilityAssessment SetServerVulnerabilityAssessmentSettings(string resourceGroupName, string serverName, ServerVulnerabilityAssessment parameters)
        {
            return GetCurrentSqlClient().ServerVulnerabilityAssessments.CreateOrUpdate(resourceGroupName, serverName, parameters);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the managed instance Vulnerability Assessment Settings for the given managed instance in the given resource group
        /// </summary>
        public ManagedInstanceVulnerabilityAssessment SetManagedInstanceVulnerabilityAssessmentSettings(string resourceGroupName, string managedInstanceName, ManagedInstanceVulnerabilityAssessment parameters)
        {
            return GetCurrentSqlClient().ManagedInstanceVulnerabilityAssessments.CreateOrUpdate(resourceGroupName, managedInstanceName, parameters);
        }

        /// <summary>
        /// Gets the database Vulnerability Assessment rule baseline for the given rule in the given database in the given database server in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessmentRuleBaseline GetDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string serverName,
            string databaseName, string ruleId, bool ruleAppliesToMaster)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessmentRuleBaselines.Get(resourceGroupName, serverName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default);
        }

        /// <summary>
        /// Gets the managed database Vulnerability Assessment rule baseline for the given rule in the given managed database in the given managed instance in the given resource group
        /// </summary>
        public DatabaseVulnerabilityAssessmentRuleBaseline GetManagedDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string managedInstanceName,
            string databaseName, string ruleId, bool ruleAppliesToMaster)
        {
            return GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentRuleBaselines.Get(resourceGroupName, managedInstanceName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default);
        }

        /// <summary>
        /// Removes the database Vulnerability Assessment rule baseline for the given rule in the given database in the given database server in the given resource group
        /// </summary>
        public void ClearDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string serverName, string databaseName, string ruleId,
            bool ruleAppliesToMaster)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessmentRuleBaselines.Delete(resourceGroupName, serverName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default);
        }

        /// <summary>
        /// Removes the managed database Vulnerability Assessment rule baseline for the given rule in the given managed database in the given managed instance in the given resource group
        /// </summary>
        public void ClearManagedDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string managedInstanceName, string databaseName, string ruleId,
            bool ruleAppliesToMaster)
        {
            GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentRuleBaselines.Delete(resourceGroupName, managedInstanceName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the database Vulnerability Assessment rule baseline for the given rule in the given database in the given database server in the given resource group
        /// </summary>
        public void SetDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string serverName, string databaseName, string ruleId,
            bool ruleAppliesToMaster, DatabaseVulnerabilityAssessmentRuleBaseline parameters)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessmentRuleBaselines.CreateOrUpdate(resourceGroupName, serverName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default, parameters);
        }

        /// <summary>
        /// Calls the set Vulnerability Assessment APIs for the managed database Vulnerability Assessment rule baseline for the given rule in the given managed database in the given managed instance in the given resource group
        /// </summary>
        public void SetManagedDatabaseVulnerabilityAssessmentRuleBaseline(string resourceGroupName, string managedInstanceName, string databaseName, string ruleId,
            bool ruleAppliesToMaster, DatabaseVulnerabilityAssessmentRuleBaseline parameters)
        {
            GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentRuleBaselines.CreateOrUpdate(resourceGroupName, managedInstanceName, databaseName, ruleId,
                ruleAppliesToMaster ? VulnerabilityAssessmentPolicyBaselineName.Master : VulnerabilityAssessmentPolicyBaselineName.Default, parameters);
        }

        /// <summary>
        /// List the Vulnerability Assessment scan records
        /// </summary>
        public List<VulnerabilityAssessmentScanRecord> ListDatabaseVulnerabilityAssessmentScanRecords(string resourceGroupName, string serverName,
            string databaseName)
        {
            return new List<VulnerabilityAssessmentScanRecord>(GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.ListByDatabase(resourceGroupName,
                serverName, databaseName));
        }

        /// <summary>
        /// List the Vulnerability Assessment scan records for managed database
        /// </summary>
        public List<VulnerabilityAssessmentScanRecord> ListManagedDatabaseVulnerabilityAssessmentScanRecords(string resourceGroupName, string managedInstanceName,
            string databaseName)
        {
            return new List<VulnerabilityAssessmentScanRecord>(GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentScans.ListByDatabase(resourceGroupName,
                managedInstanceName, databaseName));
        }

        /// <summary>
        /// Gets a Vulnerability Assessment scan records
        /// </summary>
        public VulnerabilityAssessmentScanRecord GetDatabaseVulnerabilityAssessmentScanRecord(string resourceGroupName, string serverName,
            string databaseName, string scanId)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.Get(resourceGroupName, serverName, databaseName, scanId);
        }

        /// <summary>
        /// Gets a Vulnerability Assessment scan records for managed database
        /// </summary>
        public VulnerabilityAssessmentScanRecord GetManagedDatabaseVulnerabilityAssessmentScanRecord(string resourceGroupName, string managedInstanceName,
            string databaseName, string scanId)
        {
            return GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentScans.Get(resourceGroupName, managedInstanceName, databaseName, scanId);
        }

        /// <summary>
        /// Exports a Vulnerability Assessment scan
        /// </summary>
        public DatabaseVulnerabilityAssessmentScansExport ConvertDatabaseVulnerabilityAssessmentScan(string resourceGroupName, string serverName,
            string databaseName, string scanId)
        {
            return GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.Export(resourceGroupName, serverName, databaseName, scanId);
        }

        /// <summary>
        /// Exports a Vulnerability Assessment scan managed database
        /// </summary>
        public DatabaseVulnerabilityAssessmentScansExport ConvertManagedDatabaseVulnerabilityAssessmentScan(string resourceGroupName, string managedInstanceName,
            string databaseName, string scanId)
        {
            return GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentScans.Export(resourceGroupName, managedInstanceName, databaseName, scanId);
        }

        /// <summary>
        /// Triggers a Vulnerability Assessment scan
        /// </summary>
        public void TriggerDatabaseVulnerabilityAssessmentScan(string resourceGroupName, string serverName,
            string databaseName, string scanId)
        {
            GetCurrentSqlClient().DatabaseVulnerabilityAssessmentScans.InitiateScan(resourceGroupName, serverName, databaseName, scanId);
        }

        /// <summary>
        /// Triggers a Vulnerability Assessment scan for managed database
        /// </summary>
        public void TriggerManagedDatabaseVulnerabilityAssessmentScan(string resourceGroupName, string managedInstanceName,
            string databaseName, string scanId)
        {
            GetCurrentSqlClient().ManagedDatabaseVulnerabilityAssessmentScans.InitiateScan(resourceGroupName, managedInstanceName, databaseName, scanId);
        }

        public struct StorageContainerInfo
        {
            public string StorageAccountAccessKey;
            public string StorageContainerPath;
        }

        /// <summary>
        /// Get Storage Container Info
        /// </summary>
        public StorageContainerInfo GetStorageContainerInfo(string resourceGroupName, string storageAccountName, string containerName)
        {
            var storageClient = GetCurrentStorageClient();
            var storageAccountObject = storageClient.StorageAccounts.GetProperties(resourceGroupName, storageAccountName);
            var keysObject = storageClient.StorageAccounts.ListKeys(resourceGroupName, storageAccountName);
            // TODO: Remove IfDef
#if NETSTANDARD
            var storageAccountBlobPrimaryEndpoints = storageAccountObject.PrimaryEndpoints.Blob;
            var key = keysObject.Keys.FirstOrDefault().Value;
#else
            var storageAccountBlobPrimaryEndpoints = storageAccountObject.StorageAccount.PrimaryEndpoints.Blob;
            var key = keysObject.StorageAccountKeys.Key1;
#endif
            return new StorageContainerInfo
            {
                StorageAccountAccessKey = key,
                StorageContainerPath = string.Format("{0}{1}", storageAccountBlobPrimaryEndpoints, containerName)
            };
        }

        /// <summary>
        /// Retrieve the SQL Management client for the currently selected subscription, adding the session and request
        /// id tracing headers for the current cmdlet invocation.
        /// </summary>
        /// <returns>The SQL Management client for the currently selected subscription.</returns>
        private SqlManagementClient GetCurrentSqlClient() => SqlClient ?? (SqlClient = AzureSession.Instance.ClientFactory.CreateArmClient<SqlManagementClient>(Context, AzureEnvironment.Endpoint.ResourceManager));


        /// <summary>
        /// Lazy creation of a single instance of a storage client
        /// </summary>
        private StorageManagementClient GetCurrentStorageClient() => StorageClient ?? (StorageClient = AzureEndpointsCommunicator.GetStorageV2Client(Context));
    }
}
